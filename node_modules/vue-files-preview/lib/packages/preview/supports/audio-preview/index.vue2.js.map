{"version":3,"file":"index.vue2.js","sources":["../../../../../../packages/preview/supports/audio-preview/index.vue"],"sourcesContent":["<script lang='ts' setup>\nimport {computed, getCurrentInstance, onBeforeMount, onMounted, ref} from 'vue'\nimport type {PreviewProps} from '../../preview.interface'\nimport {getFileRenderByFile} from '../../utils/utils'\n\nconst props = withDefaults(\n    defineProps<PreviewProps>(),\n    {\n      file: () => null,\n      name: () => null,\n    },\n)\n\nconst {proxy} = getCurrentInstance() as any\n\nconst audioDom = ref()\nconst ulDom = ref()\nconst containerDom = ref()\nconst canvasDom = ref()\nconst ctx = ref()\nconst isInit = ref(false)\nconst analyser = ref()\nconst dataSource = ref()\nconst mode = ref('Wavy')\nconst src = ref(null)\n\n/**\n * 初始化 Dom\n */\nfunction initDom(): void {\n  audioDom.value = proxy.$refs.audioRef as HTMLAudioElement\n  ulDom.value = proxy.$refs.ulRef as HTMLUListElement\n  containerDom.value = proxy.$refs.containerRef as HTMLDivElement\n  canvasDom.value = proxy.$refs.canvasRef as HTMLDivElement\n  ctx.value = canvasDom.value.getContext('2d')\n}\n\nconst containerHeight = computed(() => {\n  return containerDom.value?.clientHeight\n})\nconst liHeight = computed(() => {\n  return ulDom.value.children[0]?.clientHeight\n})\nconst maxOffset = computed(() => {\n  return ulDom.value?.clientHeight - containerHeight.value\n})\n\n/**\n * 初始化canvas\n */\nfunction initCanvas() {\n  canvasDom.value.width = window.innerWidth * devicePixelRatio\n  canvasDom.value.height = 300\n}\n\n/**\n * 音频播放\n */\nfunction audioPlay() {\n  audioDom.value.onplay = () => {\n    if (isInit.value)\n      return\n    const audCtx = new AudioContext() // 音频上下文\n    const source = audCtx.createMediaElementSource(audioDom.value) // 音频源节点\n    analyser.value = audCtx.createAnalyser()\n    analyser.value.fftSize = 512\n    dataSource.value = new Uint8Array(analyser.value.frequencyBinCount)\n    source.connect(analyser.value)\n    analyser.value.connect(audCtx.destination)\n\n    isInit.value = true\n  }\n}\n\n// 柱状\nfunction drawColumnar() {\n  requestAnimationFrame(drawColumnar)\n  const {width, height} = canvasDom.value\n  ctx.value.clearRect(0, 0, width, height)\n  if (!isInit.value)\n    return\n  if (dataSource.value) {\n    analyser.value && analyser.value.getByteFrequencyData(dataSource.value)\n\n    const len = dataSource.value.length\n    const barWidth = width / len\n    ctx.value.fillStyle = 'skyblue'\n    dataSource.value.forEach((v, i) => {\n      const barHeight = v / 255 * height\n      const x = i * barWidth\n      const y = height - barHeight\n      ctx.value.fillRect(x, y, barWidth, barHeight)\n    })\n  }\n}\n\n// 波浪\nfunction drawWavy() {\n  requestAnimationFrame(drawWavy)\n  const {width, height} = canvasDom.value\n  ctx.value.clearRect(0, 0, width, height)\n  if (!isInit.value)\n    return\n  if (dataSource.value) {\n    analyser.value && analyser.value.getByteFrequencyData(dataSource.value)\n\n    const len = dataSource.value.length\n    const sliceWidth = width * 1.0 / len\n    let x = 0\n\n    ctx.value.beginPath()\n    ctx.value.strokeStyle = 'skyblue'\n    dataSource.value.forEach((v, i) => {\n      const vNormalized = v / 255\n      const y = vNormalized * height / 2\n\n      if (i === 0)\n        ctx.value.moveTo(x, y)\n      else\n        ctx.value.lineTo(x, y)\n\n      x += sliceWidth\n    })\n\n    ctx.value.lineTo(width, height / 2)\n    ctx.value.stroke()\n  }\n}\n\n/**\n * 切换模式\n */\nfunction changeMode() {\n  mode.value = mode.value === 'Columnar' ? 'Wavy' : 'Columnar'\n  mode.value == 'Columnar' ? drawColumnar() : drawWavy()\n}\n\nonBeforeMount(() => {\n  getFileRenderByFile(props.file).then((render) => {\n    src.value = render\n  })\n})\nonMounted(() => {\n  initDom() // 初始化 Dom\n  audioPlay() // 音频播放\n  initCanvas() // 初始化 canvas\n  drawWavy() // 绘制波浪\n})\n</script>\n\n<template>\n  <div class=\"audio-preview music-container flex flex-column flex-align\">\n    <div class=\"audio-container flex-align\">\n      <div class=\"flex-column\" style=\"margin-left: 0.5rem;\">\n        <div style=\"font-size: 1.6rem; color: #999;\">\n          {{ name }}\n        </div>\n      </div>\n      <div class=\"mp3Box\">\n        <audio ref=\"audioRef\" controls :src=\"src\"/>\n      </div>\n      <div>\n        <el-button link @click=\"changeMode\">\n          {{ mode }}\n        </el-button>\n      </div>\n    </div>\n    <div class=\"cvs-container\">\n      <canvas ref=\"canvasRef\"/>\n    </div>\n  </div>\n</template>\n\n<style scoped lang=\"scss\">\n.music-container {\n  height: 100vh;\n  background: #1b1d1d;\n\n  audio {\n    width: 450px;\n    margin: 0 1.2rem;\n    background: #303233;\n    border-radius: 54px;\n  }\n\n  audio::-webkit-media-controls-panel {\n    background-image: initial;\n    background-color: #777;\n    transition: none;\n  }\n\n  audio::-webkit-media-controls-current-time-display,\n  audio::-webkit-media-controls-time-remaining-display {\n    background: #777;\n    text-shadow: none;\n  }\n\n  .audio-container {\n    height: 5.2rem;\n    // border: 1px solid #777;\n  }\n\n  .lrc-container {\n    width: 100%;\n    padding-top: 30px;\n    flex: 1;\n    height: 220px;\n    text-align: center;\n    overflow: hidden;\n    position: relative;\n\n    &::before,\n    &::after {\n      content: \"\";\n      position: absolute;\n      left: 0;\n      width: 100%;\n      height: 100px;\n      background: linear-gradient(to bottom, rgba(27, 29, 29, 1), rgba(255, 255, 255, 0));\n      pointer-events: none;\n    }\n\n    &::before {\n      top: 0;\n    }\n\n    &::after {\n      bottom: 0;\n      transform: rotate(180deg);\n    }\n\n    ul {\n      transition: 0.6s;\n      list-style: none;\n      color: #ffffff70;\n\n      li {\n        height: 30px;\n        line-height: 30px;\n        transition: 0.2s;\n\n        &.active {\n          font-weight: 700;\n          color: #fff;\n          transform: scale(1.2);\n        }\n      }\n    }\n  }\n\n  .cvs-container {\n    padding-top: 10px;\n  }\n}\n\n.flex-column {\n  display: flex;\n  flex-direction: column;\n}\n\n.flex-align {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n</style>\n"],"names":["props","__props","proxy","getCurrentInstance","audioDom","ref","ulDom","containerDom","canvasDom","ctx","isInit","analyser","dataSource","mode","src","initDom","containerHeight","computed","_a","initCanvas","audioPlay","audCtx","source","drawColumnar","width","height","len","barWidth","v","i","barHeight","x","y","drawWavy","sliceWidth","changeMode","onBeforeMount","getFileRenderByFile","render","onMounted"],"mappings":"+cAKA,MAAMA,EAAQC,EAQR,CAAC,MAAAC,GAASC,EAAAA,qBAEVC,EAAWC,EAAAA,MACXC,EAAQD,EAAAA,MACRE,EAAeF,EAAAA,MACfG,EAAYH,EAAAA,MACZI,EAAMJ,EAAAA,MACNK,EAASL,MAAI,EAAK,EAClBM,EAAWN,EAAAA,MACXO,EAAaP,EAAAA,MACbQ,EAAOR,MAAI,MAAM,EACjBS,EAAMT,MAAI,IAAI,EAKpB,SAASU,GAAgB,CACdX,EAAA,MAAQF,EAAM,MAAM,SACvBI,EAAA,MAAQJ,EAAM,MAAM,MACbK,EAAA,MAAQL,EAAM,MAAM,aACvBM,EAAA,MAAQN,EAAM,MAAM,UAC9BO,EAAI,MAAQD,EAAU,MAAM,WAAW,IAAI,CAC7C,CAEM,MAAAQ,EAAkBC,EAAAA,SAAS,IAAM,OACrC,OAAOC,EAAAX,EAAa,QAAb,YAAAW,EAAoB,YAAA,CAC5B,EACgBD,EAAAA,SAAS,IAAM,OAC9B,OAAOC,EAAAZ,EAAM,MAAM,SAAS,CAAC,IAAtB,YAAAY,EAAyB,YAAA,CACjC,EACiBD,EAAAA,SAAS,IAAM,OACxB,QAAAC,EAAAZ,EAAM,QAAN,YAAAY,EAAa,cAAeF,EAAgB,KAAA,CACpD,EAKD,SAASG,GAAa,CACVX,EAAA,MAAM,MAAQ,OAAO,WAAa,iBAC5CA,EAAU,MAAM,OAAS,GAC3B,CAKA,SAASY,GAAY,CACVhB,EAAA,MAAM,OAAS,IAAM,CAC5B,GAAIM,EAAO,MACT,OACI,MAAAW,EAAS,IAAI,aACbC,EAASD,EAAO,yBAAyBjB,EAAS,KAAK,EACpDO,EAAA,MAAQU,EAAO,iBACxBV,EAAS,MAAM,QAAU,IACzBC,EAAW,MAAQ,IAAI,WAAWD,EAAS,MAAM,iBAAiB,EAC3DW,EAAA,QAAQX,EAAS,KAAK,EACpBA,EAAA,MAAM,QAAQU,EAAO,WAAW,EAEzCX,EAAO,MAAQ,EAAA,CAEnB,CAGA,SAASa,GAAe,CACtB,sBAAsBA,CAAY,EAClC,KAAM,CAAC,MAAAC,EAAO,OAAAC,GAAUjB,EAAU,MAElC,GADAC,EAAI,MAAM,UAAU,EAAG,EAAGe,EAAOC,CAAM,EACnC,EAACf,EAAO,OAERE,EAAW,MAAO,CACpBD,EAAS,OAASA,EAAS,MAAM,qBAAqBC,EAAW,KAAK,EAEhE,MAAAc,EAAMd,EAAW,MAAM,OACvBe,EAAWH,EAAQE,EACzBjB,EAAI,MAAM,UAAY,UACtBG,EAAW,MAAM,QAAQ,CAACgB,EAAGC,IAAM,CAC3B,MAAAC,EAAYF,EAAI,IAAMH,EACtBM,EAAIF,EAAIF,EACRK,EAAIP,EAASK,EACnBrB,EAAI,MAAM,SAASsB,EAAGC,EAAGL,EAAUG,CAAS,CAAA,CAC7C,CACH,CACF,CAGA,SAASG,GAAW,CAClB,sBAAsBA,CAAQ,EAC9B,KAAM,CAAC,MAAAT,EAAO,OAAAC,GAAUjB,EAAU,MAElC,GADAC,EAAI,MAAM,UAAU,EAAG,EAAGe,EAAOC,CAAM,EACnC,EAACf,EAAO,OAERE,EAAW,MAAO,CACpBD,EAAS,OAASA,EAAS,MAAM,qBAAqBC,EAAW,KAAK,EAEhE,MAAAc,EAAMd,EAAW,MAAM,OACvBsB,EAAaV,EAAQ,EAAME,EACjC,IAAIK,EAAI,EAERtB,EAAI,MAAM,YACVA,EAAI,MAAM,YAAc,UACxBG,EAAW,MAAM,QAAQ,CAACgB,EAAGC,IAAM,CAE3B,MAAAG,EADcJ,EAAI,IACAH,EAAS,EAE7BI,IAAM,EACJpB,EAAA,MAAM,OAAOsB,EAAGC,CAAC,EAEjBvB,EAAA,MAAM,OAAOsB,EAAGC,CAAC,EAElBD,GAAAG,CAAA,CACN,EAEDzB,EAAI,MAAM,OAAOe,EAAOC,EAAS,CAAC,EAClChB,EAAI,MAAM,QACZ,CACF,CAKA,SAAS0B,GAAa,CACpBtB,EAAK,MAAQA,EAAK,QAAU,WAAa,OAAS,WAClDA,EAAK,OAAS,WAAaU,EAAa,EAAIU,EAAS,CACvD,CAEAG,OAAAA,EAAAA,cAAc,IAAM,CAClBC,EAAAA,oBAAoBrC,EAAM,IAAI,EAAE,KAAMsC,GAAW,CAC/CxB,EAAI,MAAQwB,CAAA,CACb,CAAA,CACF,EACDC,EAAAA,UAAU,IAAM,CACNxB,IACEK,IACCD,IACFc,GAAA,CACV"}