"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const f=require("../../../../../@codemirror_view@6.33.0/node_modules/@codemirror/view/dist/index.js"),u=require("../../../../../@codemirror_state@6.4.1/node_modules/@codemirror/state/dist/index.js"),h=require("../../../../../crelt@1.0.6/node_modules/crelt/index.js");class M{constructor(e,i,n){this.from=e,this.to=i,this.diagnostic=n}}class g{constructor(e,i,n){this.diagnostics=e,this.panel=i,this.selected=n}static init(e,i,n){let o=e,s=n.facet(x).markerFilter;s&&(o=s(o,n));let a=f.Decoration.set(o.map(l=>l.from==l.to||l.from==l.to-1&&n.doc.lineAt(l.from).to==l.from?f.Decoration.widget({widget:new V(l),diagnostic:l}).range(l.from):f.Decoration.mark({attributes:{class:"cm-lintRange cm-lintRange-"+l.severity+(l.markClass?" "+l.markClass:"")},diagnostic:l}).range(l.from,l.to)),!0);return new g(a,i,b(a))}}function b(t,e=null,i=0){let n=null;return t.between(i,1e9,(o,s,{spec:a})=>{if(!(e&&a.diagnostic!=e))return n=new M(o,s,a.diagnostic),!1}),n}function T(t,e){let i=e.pos,n=e.end||i,o=t.state.facet(x).hideOn(t,i,n);if(o!=null)return o;let s=t.startState.doc.lineAt(e.pos);return!!(t.effects.some(a=>a.is(S))||t.changes.touchesRange(s.from,Math.max(s.to,n)))}function B(t,e){return t.field(m,!1)?e:e.concat(u.StateEffect.appendConfig.of(_))}const S=u.StateEffect.define(),v=u.StateEffect.define(),P=u.StateEffect.define(),m=u.StateField.define({create(){return new g(f.Decoration.none,null,null)},update(t,e){if(e.docChanged&&t.diagnostics.size){let i=t.diagnostics.map(e.changes),n=null,o=t.panel;if(t.selected){let s=e.changes.mapPos(t.selected.from,1);n=b(i,t.selected.diagnostic,s)||b(i,null,s)}!i.size&&o&&e.state.facet(x).autoPanel&&(o=null),t=new g(i,o,n)}for(let i of e.effects)if(i.is(S)){let n=e.state.facet(x).autoPanel?i.value.length?k.open:null:t.panel;t=g.init(i.value,n,e.state)}else i.is(v)?t=new g(t.diagnostics,i.value?k.open:null,t.selected):i.is(P)&&(t=new g(t.diagnostics,t.panel,i.value));return t},provide:t=>[f.showPanel.from(t,e=>e.panel),f.EditorView.decorations.from(t,e=>e.diagnostics)]}),F=f.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function $(t,e,i){let{diagnostics:n}=t.state.field(m),o=[],s=2e8,a=0;n.between(e-(i<0?1:0),e+(i>0?1:0),(c,d,{spec:r})=>{e>=c&&e<=d&&(c==d||(e>c||i>0)&&(e<d||i<0))&&(o.push(r.diagnostic),s=Math.min(c,s),a=Math.max(d,a))});let l=t.state.facet(x).tooltipFilter;return l&&(o=l(o,t.state)),o.length?{pos:s,end:a,above:t.state.doc.lineAt(s).to<a,create(){return{dom:O(t,o)}}}:null}function O(t,e){return h("ul",{class:"cm-tooltip-lint"},e.map(i=>L(t,i,!1)))}const R=t=>{let e=t.state.field(m,!1);(!e||!e.panel)&&t.dispatch({effects:B(t.state,[v.of(!0)])});let i=f.getPanel(t,k.open);return i&&i.dom.querySelector(".cm-panel-lint ul").focus(),!0},C=t=>{let e=t.state.field(m,!1);return!e||!e.panel?!1:(t.dispatch({effects:v.of(!1)}),!0)},I=t=>{let e=t.state.field(m,!1);if(!e)return!1;let i=t.state.selection.main,n=e.diagnostics.iter(i.to+1);return!n.value&&(n=e.diagnostics.iter(0),!n.value||n.from==i.from&&n.to==i.to)?!1:(t.dispatch({selection:{anchor:n.from,head:n.to},scrollIntoView:!0}),!0)},q=[{key:"Mod-Shift-m",run:R,preventDefault:!0},{key:"F8",run:I}],x=u.Facet.define({combine(t){return Object.assign({sources:t.map(e=>e.source).filter(e=>e!=null)},u.combineConfig(t.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{needsRefresh:(e,i)=>e?i?n=>e(n)||i(n):e:i}))}});function A(t){let e=[];if(t)e:for(let{name:i}of t){for(let n=0;n<i.length;n++){let o=i[n];if(/[a-zA-Z]/.test(o)&&!e.some(s=>s.toLowerCase()==o.toLowerCase())){e.push(o);continue e}}e.push("")}return e}function L(t,e,i){var n;let o=i?A(e.actions):[];return h("li",{class:"cm-diagnostic cm-diagnostic-"+e.severity},h("span",{class:"cm-diagnosticText"},e.renderMessage?e.renderMessage(t):e.message),(n=e.actions)===null||n===void 0?void 0:n.map((s,a)=>{let l=!1,c=E=>{if(E.preventDefault(),l)return;l=!0;let y=b(t.state.field(m).diagnostics,e);y&&s.apply(t,y.from,y.to)},{name:d}=s,r=o[a]?d.indexOf(o[a]):-1,p=r<0?d:[d.slice(0,r),h("u",d.slice(r,r+1)),d.slice(r+1)];return h("button",{type:"button",class:"cm-diagnosticAction",onclick:c,onmousedown:c,"aria-label":` Action: ${d}${r<0?"":` (access key "${o[a]})"`}.`},p)}),e.source&&h("div",{class:"cm-diagnosticSource"},e.source))}class V extends f.WidgetType{constructor(e){super(),this.diagnostic=e}eq(e){return e.diagnostic==this.diagnostic}toDOM(){return h("span",{class:"cm-lintPoint cm-lintPoint-"+this.diagnostic.severity})}}class D{constructor(e,i){this.diagnostic=i,this.id="item_"+Math.floor(Math.random()*4294967295).toString(16),this.dom=L(e,i,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class k{constructor(e){this.view=e,this.items=[];let i=o=>{if(o.keyCode==27)C(this.view),this.view.focus();else if(o.keyCode==38||o.keyCode==33)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(o.keyCode==40||o.keyCode==34)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(o.keyCode==36)this.moveSelection(0);else if(o.keyCode==35)this.moveSelection(this.items.length-1);else if(o.keyCode==13)this.view.focus();else if(o.keyCode>=65&&o.keyCode<=90&&this.selectedIndex>=0){let{diagnostic:s}=this.items[this.selectedIndex],a=A(s.actions);for(let l=0;l<a.length;l++)if(a[l].toUpperCase().charCodeAt(0)==o.keyCode){let c=b(this.view.state.field(m).diagnostics,s);c&&s.actions[l].apply(e,c.from,c.to)}}else return;o.preventDefault()},n=o=>{for(let s=0;s<this.items.length;s++)this.items[s].dom.contains(o.target)&&this.moveSelection(s)};this.list=h("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:i,onclick:n}),this.dom=h("div",{class:"cm-panel-lint"},this.list,h("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>C(this.view)},"Ã—")),this.update()}get selectedIndex(){let e=this.view.state.field(m).selected;if(!e)return-1;for(let i=0;i<this.items.length;i++)if(this.items[i].diagnostic==e.diagnostic)return i;return-1}update(){let{diagnostics:e,selected:i}=this.view.state.field(m),n=0,o=!1,s=null;for(e.between(0,this.view.state.doc.length,(a,l,{spec:c})=>{let d=-1,r;for(let p=n;p<this.items.length;p++)if(this.items[p].diagnostic==c.diagnostic){d=p;break}d<0?(r=new D(this.view,c.diagnostic),this.items.splice(n,0,r),o=!0):(r=this.items[d],d>n&&(this.items.splice(n,d-n),o=!0)),i&&r.diagnostic==i.diagnostic?r.dom.hasAttribute("aria-selected")||(r.dom.setAttribute("aria-selected","true"),s=r):r.dom.hasAttribute("aria-selected")&&r.dom.removeAttribute("aria-selected"),n++});n<this.items.length&&!(this.items.length==1&&this.items[0].diagnostic.from<0);)o=!0,this.items.pop();this.items.length==0&&(this.items.push(new D(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),o=!0),s?(this.list.setAttribute("aria-activedescendant",s.id),this.view.requestMeasure({key:this,read:()=>({sel:s.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:a,panel:l})=>{let c=l.height/this.list.offsetHeight;a.top<l.top?this.list.scrollTop-=(l.top-a.top)/c:a.bottom>l.bottom&&(this.list.scrollTop+=(a.bottom-l.bottom)/c)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),o&&this.sync()}sync(){let e=this.list.firstChild;function i(){let n=e;e=n.nextSibling,n.remove()}for(let n of this.items)if(n.dom.parentNode==this.list){for(;e!=n.dom;)i();e=n.dom.nextSibling}else this.list.insertBefore(n.dom,e);for(;e;)i()}moveSelection(e){if(this.selectedIndex<0)return;let i=this.view.state.field(m),n=b(i.diagnostics,this.items[e].diagnostic);n&&this.view.dispatch({selection:{anchor:n.from,head:n.to},scrollIntoView:!0,effects:P.of(n)})}static open(e){return new k(e)}}function z(t,e='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${e}>${encodeURIComponent(t)}</svg>')`}function w(t){return z(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${t}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const H=f.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:w("#d11")},".cm-lintRange-warning":{backgroundImage:w("orange")},".cm-lintRange-info":{backgroundImage:w("#999")},".cm-lintRange-hint":{backgroundImage:w("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}}),_=[m,f.EditorView.decorations.compute([m],t=>{let{selected:e,panel:i}=t.field(m);return!e||!i||e.from==e.to?f.Decoration.none:f.Decoration.set([F.range(e.from,e.to)])}),f.hoverTooltip($,{hideOn:T}),H];exports.closeLintPanel=C;exports.lintKeymap=q;exports.nextDiagnostic=I;exports.openLintPanel=R;exports.setDiagnosticsEffect=S;
//# sourceMappingURL=index.js.map
