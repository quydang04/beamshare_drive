"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("./generated/decode-data-html.js"),N=require("./generated/decode-data-xml.js"),o=require("./decode_codepoint.js");var c;(function(t){t[t.NUM=35]="NUM",t[t.SEMI=59]="SEMI",t[t.EQUALS=61]="EQUALS",t[t.ZERO=48]="ZERO",t[t.NINE=57]="NINE",t[t.LOWER_A=97]="LOWER_A",t[t.LOWER_F=102]="LOWER_F",t[t.LOWER_X=120]="LOWER_X",t[t.LOWER_Z=122]="LOWER_Z",t[t.UPPER_A=65]="UPPER_A",t[t.UPPER_F=70]="UPPER_F",t[t.UPPER_Z=90]="UPPER_Z"})(c||(c={}));const A=32;exports.BinTrieFlags=void 0;(function(t){t[t.VALUE_LENGTH=49152]="VALUE_LENGTH",t[t.BRANCH_LENGTH=16256]="BRANCH_LENGTH",t[t.JUMP_TABLE=127]="JUMP_TABLE"})(exports.BinTrieFlags||(exports.BinTrieFlags={}));function E(t){return t>=c.ZERO&&t<=c.NINE}function P(t){return t>=c.UPPER_A&&t<=c.UPPER_F||t>=c.LOWER_A&&t<=c.LOWER_F}function T(t){return t>=c.UPPER_A&&t<=c.UPPER_Z||t>=c.LOWER_A&&t<=c.LOWER_Z||E(t)}function x(t){return t===c.EQUALS||T(t)}var s;(function(t){t[t.EntityStart=0]="EntityStart",t[t.NumericStart=1]="NumericStart",t[t.NumericDecimal=2]="NumericDecimal",t[t.NumericHex=3]="NumericHex",t[t.NamedEntity=4]="NamedEntity"})(s||(s={}));exports.DecodingMode=void 0;(function(t){t[t.Legacy=0]="Legacy",t[t.Strict=1]="Strict",t[t.Attribute=2]="Attribute"})(exports.DecodingMode||(exports.DecodingMode={}));class L{constructor(e,i,r){this.decodeTree=e,this.emitCodePoint=i,this.errors=r,this.state=s.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=exports.DecodingMode.Strict}startEntity(e){this.decodeMode=e,this.state=s.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(e,i){switch(this.state){case s.EntityStart:return e.charCodeAt(i)===c.NUM?(this.state=s.NumericStart,this.consumed+=1,this.stateNumericStart(e,i+1)):(this.state=s.NamedEntity,this.stateNamedEntity(e,i));case s.NumericStart:return this.stateNumericStart(e,i);case s.NumericDecimal:return this.stateNumericDecimal(e,i);case s.NumericHex:return this.stateNumericHex(e,i);case s.NamedEntity:return this.stateNamedEntity(e,i)}}stateNumericStart(e,i){return i>=e.length?-1:(e.charCodeAt(i)|A)===c.LOWER_X?(this.state=s.NumericHex,this.consumed+=1,this.stateNumericHex(e,i+1)):(this.state=s.NumericDecimal,this.stateNumericDecimal(e,i))}addToNumericResult(e,i,r,n){if(i!==r){const u=r-i;this.result=this.result*Math.pow(n,u)+parseInt(e.substr(i,u),n),this.consumed+=u}}stateNumericHex(e,i){const r=i;for(;i<e.length;){const n=e.charCodeAt(i);if(E(n)||P(n))i+=1;else return this.addToNumericResult(e,r,i,16),this.emitNumericEntity(n,3)}return this.addToNumericResult(e,r,i,16),-1}stateNumericDecimal(e,i){const r=i;for(;i<e.length;){const n=e.charCodeAt(i);if(E(n))i+=1;else return this.addToNumericResult(e,r,i,10),this.emitNumericEntity(n,2)}return this.addToNumericResult(e,r,i,10),-1}emitNumericEntity(e,i){var r;if(this.consumed<=i)return(r=this.errors)===null||r===void 0||r.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(e===c.SEMI)this.consumed+=1;else if(this.decodeMode===exports.DecodingMode.Strict)return 0;return this.emitCodePoint(o.replaceCodePoint(this.result),this.consumed),this.errors&&(e!==c.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(e,i){const{decodeTree:r}=this;let n=r[this.treeIndex],u=(n&exports.BinTrieFlags.VALUE_LENGTH)>>14;for(;i<e.length;i++,this.excess++){const a=e.charCodeAt(i);if(this.treeIndex=R(r,n,this.treeIndex+Math.max(1,u),a),this.treeIndex<0)return this.result===0||this.decodeMode===exports.DecodingMode.Attribute&&(u===0||x(a))?0:this.emitNotTerminatedNamedEntity();if(n=r[this.treeIndex],u=(n&exports.BinTrieFlags.VALUE_LENGTH)>>14,u!==0){if(a===c.SEMI)return this.emitNamedEntityData(this.treeIndex,u,this.consumed+this.excess);this.decodeMode!==exports.DecodingMode.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var e;const{result:i,decodeTree:r}=this,n=(r[i]&exports.BinTrieFlags.VALUE_LENGTH)>>14;return this.emitNamedEntityData(i,n,this.consumed),(e=this.errors)===null||e===void 0||e.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(e,i,r){const{decodeTree:n}=this;return this.emitCodePoint(i===1?n[e]&~exports.BinTrieFlags.VALUE_LENGTH:n[e+1],r),i===3&&this.emitCodePoint(n[e+2],r),r}end(){var e;switch(this.state){case s.NamedEntity:return this.result!==0&&(this.decodeMode!==exports.DecodingMode.Attribute||this.result===this.treeIndex)?this.emitNotTerminatedNamedEntity():0;case s.NumericDecimal:return this.emitNumericEntity(0,2);case s.NumericHex:return this.emitNumericEntity(0,3);case s.NumericStart:return(e=this.errors)===null||e===void 0||e.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case s.EntityStart:return 0}}}function _(t){let e="";const i=new L(t,r=>e+=o.fromCodePoint(r));return function(n,u){let a=0,m=0;for(;(m=n.indexOf("&",m))>=0;){e+=n.slice(a,m),i.startEntity(u);const d=i.write(n,m+1);if(d<0){a=m+i.end();break}a=m+d,m=d===0?a+1:a}const h=e+n.slice(a);return e="",h}}function R(t,e,i,r){const n=(e&exports.BinTrieFlags.BRANCH_LENGTH)>>7,u=e&exports.BinTrieFlags.JUMP_TABLE;if(n===0)return u!==0&&r===u?i:-1;if(u){const h=r-u;return h<0||h>=n?-1:t[i+h]-1}let a=i,m=a+n-1;for(;a<=m;){const h=a+m>>>1,d=t[h];if(d<r)a=h+1;else if(d>r)m=h-1;else return t[h+n]}return-1}const y=_(l);_(N);function M(t,e=exports.DecodingMode.Legacy){return y(t,e)}exports.htmlDecodeTree=l;exports.xmlDecodeTree=N;exports.fromCodePoint=o.fromCodePoint;exports.replaceCodePoint=o.replaceCodePoint;exports.EntityDecoder=L;exports.decodeHTML=M;exports.determineBranch=R;
//# sourceMappingURL=decode.js.map
