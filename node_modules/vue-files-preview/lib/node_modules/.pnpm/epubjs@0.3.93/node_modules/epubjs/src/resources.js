"use strict";const u=require("./utils/replacements.js"),h=require("./utils/core.js"),o=require("./utils/url.js"),f=require("./utils/mime.js"),a=require("./utils/path.js"),m=require("../../../../path-webpack@0.0.3/node_modules/path-webpack/path.js");class p{constructor(e,t){this.settings={replacements:t&&t.replacements||"base64",archive:t&&t.archive,resolver:t&&t.resolver,request:t&&t.request},this.process(e)}process(e){this.manifest=e,this.resources=Object.keys(e).map(function(t){return e[t]}),this.replacementUrls=[],this.html=[],this.assets=[],this.css=[],this.urls=[],this.cssUrls=[],this.split(),this.splitUrls()}split(){this.html=this.resources.filter(function(e){if(e.type==="application/xhtml+xml"||e.type==="text/html")return!0}),this.assets=this.resources.filter(function(e){if(e.type!=="application/xhtml+xml"&&e.type!=="text/html")return!0}),this.css=this.resources.filter(function(e){if(e.type==="text/css")return!0})}splitUrls(){this.urls=this.assets.map((function(e){return e.href}).bind(this)),this.cssUrls=this.css.map(function(e){return e.href})}createUrl(e){var t=new o(e),s=f.lookup(t.filename);return this.settings.archive?this.settings.archive.createUrl(e,{base64:this.settings.replacements==="base64"}):this.settings.replacements==="base64"?this.settings.request(e,"blob").then(r=>h.blob2base64(r)).then(r=>h.createBase64Url(r,s)):this.settings.request(e,"blob").then(r=>h.createBlobUrl(r,s))}replacements(){if(this.settings.replacements==="none")return new Promise((function(t){t(this.urls)}).bind(this));var e=this.urls.map(t=>{var s=this.settings.resolver(t);return this.createUrl(s).catch(r=>(console.error(r),null))});return Promise.all(e).then(t=>(this.replacementUrls=t.filter(s=>typeof s=="string"),t))}replaceCss(e,t){var s=[];return e=e||this.settings.archive,t=t||this.settings.resolver,this.cssUrls.forEach((function(r){var l=this.createCssFile(r,e,t).then((function(i){var n=this.urls.indexOf(r);n>-1&&(this.replacementUrls[n]=i)}).bind(this));s.push(l)}).bind(this)),Promise.all(s)}createCssFile(e){var t;if(m.isAbsolute(e))return new Promise(function(i){i()});var s=this.settings.resolver(e),r;this.settings.archive?r=this.settings.archive.getText(s):r=this.settings.request(s,"text");var l=this.urls.map(i=>{var n=this.settings.resolver(i),c=new a(s).relative(n);return c});return r?r.then(i=>(i=u.substitute(i,l,this.replacementUrls),this.settings.replacements==="base64"?t=h.createBase64Url(i,"text/css"):t=h.createBlobUrl(i,"text/css"),t),i=>new Promise(function(n){n()})):new Promise(function(i){i()})}relativeTo(e,t){return t=t||this.settings.resolver,this.urls.map((function(s){var r=t(s),l=new a(e).relative(r);return l}).bind(this))}get(e){var t=this.urls.indexOf(e);if(t!==-1)return this.replacementUrls.length?new Promise((function(s,r){s(this.replacementUrls[t])}).bind(this)):this.createUrl(e)}substitute(e,t){var s;return t?s=this.relativeTo(t):s=this.urls,u.substitute(e,s,this.replacementUrls)}destroy(){this.settings=void 0,this.manifest=void 0,this.resources=void 0,this.replacementUrls=void 0,this.html=void 0,this.assets=void 0,this.css=void 0,this.urls=void 0,this.cssUrls=void 0}}module.exports=p;
//# sourceMappingURL=resources.js.map
