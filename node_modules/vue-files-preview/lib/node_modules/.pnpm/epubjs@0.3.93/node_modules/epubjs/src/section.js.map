{"version":3,"file":"section.js","sources":["../../../../../../../../node_modules/.pnpm/epubjs@0.3.93/node_modules/epubjs/src/section.js"],"sourcesContent":["import { defer } from \"./utils/core\";\nimport EpubCFI from \"./epubcfi\";\nimport Hook from \"./utils/hook\";\nimport { sprint } from \"./utils/core\";\nimport { replaceBase } from \"./utils/replacements\";\nimport Request from \"./utils/request\";\nimport { DOMParser as XMLDOMSerializer } from \"@xmldom/xmldom\";\n\n/**\n * Represents a Section of the Book\n *\n * In most books this is equivalent to a Chapter\n * @param {object} item  The spine item representing the section\n * @param {object} hooks hooks for serialize and content\n */\nclass Section {\n\tconstructor(item, hooks){\n\t\tthis.idref = item.idref;\n\t\tthis.linear = item.linear === \"yes\";\n\t\tthis.properties = item.properties;\n\t\tthis.index = item.index;\n\t\tthis.href = item.href;\n\t\tthis.url = item.url;\n\t\tthis.canonical = item.canonical;\n\t\tthis.next = item.next;\n\t\tthis.prev = item.prev;\n\n\t\tthis.cfiBase = item.cfiBase;\n\n\t\tif (hooks) {\n\t\t\tthis.hooks = hooks;\n\t\t} else {\n\t\t\tthis.hooks = {};\n\t\t\tthis.hooks.serialize = new Hook(this);\n\t\t\tthis.hooks.content = new Hook(this);\n\t\t}\n\n\t\tthis.document = undefined;\n\t\tthis.contents = undefined;\n\t\tthis.output = undefined;\n\t}\n\n\t/**\n\t * Load the section from its url\n\t * @param  {method} [_request] a request method to use for loading\n\t * @return {document} a promise with the xml document\n\t */\n\tload(_request){\n\t\tvar request = _request || this.request || Request;\n\t\tvar loading = new defer();\n\t\tvar loaded = loading.promise;\n\n\t\tif(this.contents) {\n\t\t\tloading.resolve(this.contents);\n\t\t} else {\n\t\t\trequest(this.url)\n\t\t\t\t.then(function(xml){\n\t\t\t\t\t// var directory = new Url(this.url).directory;\n\n\t\t\t\t\tthis.document = xml;\n\t\t\t\t\tthis.contents = xml.documentElement;\n\n\t\t\t\t\treturn this.hooks.content.trigger(this.document, this);\n\t\t\t\t}.bind(this))\n\t\t\t\t.then(function(){\n\t\t\t\t\tloading.resolve(this.contents);\n\t\t\t\t}.bind(this))\n\t\t\t\t.catch(function(error){\n\t\t\t\t\tloading.reject(error);\n\t\t\t\t});\n\t\t}\n\n\t\treturn loaded;\n\t}\n\n\t/**\n\t * Adds a base tag for resolving urls in the section\n\t * @private\n\t */\n\tbase(){\n\t\treturn replaceBase(this.document, this);\n\t}\n\n\t/**\n\t * Render the contents of a section\n\t * @param  {method} [_request] a request method to use for loading\n\t * @return {string} output a serialized XML Document\n\t */\n\trender(_request){\n\t\tvar rendering = new defer();\n\t\tvar rendered = rendering.promise;\n\t\tthis.output; // TODO: better way to return this from hooks?\n\n\t\tthis.load(_request).\n\t\t\tthen(function(contents){\n\t\t\t\tvar userAgent = (typeof navigator !== 'undefined' && navigator.userAgent) || '';\n\t\t\t\tvar isIE = userAgent.indexOf('Trident') >= 0;\n\t\t\t\tvar Serializer;\n\t\t\t\tif (typeof XMLSerializer === \"undefined\" || isIE) {\n\t\t\t\t\tSerializer = XMLDOMSerializer;\n\t\t\t\t} else {\n\t\t\t\t\tSerializer = XMLSerializer;\n\t\t\t\t}\n\t\t\t\tvar serializer = new Serializer();\n\t\t\t\tthis.output = serializer.serializeToString(contents);\n\t\t\t\treturn this.output;\n\t\t\t}.bind(this)).\n\t\t\tthen(function(){\n\t\t\t\treturn this.hooks.serialize.trigger(this.output, this);\n\t\t\t}.bind(this)).\n\t\t\tthen(function(){\n\t\t\t\trendering.resolve(this.output);\n\t\t\t}.bind(this))\n\t\t\t.catch(function(error){\n\t\t\t\trendering.reject(error);\n\t\t\t});\n\n\t\treturn rendered;\n\t}\n\n\t/**\n\t * Find a string in a section\n\t * @param  {string} _query The query string to find\n\t * @return {object[]} A list of matches, with form {cfi, excerpt}\n\t */\n\tfind(_query){\n\t\tvar section = this;\n\t\tvar matches = [];\n\t\tvar query = _query.toLowerCase();\n\t\tvar find = function(node){\n\t\t\tvar text = node.textContent.toLowerCase();\n\t\t\tvar range = section.document.createRange();\n\t\t\tvar cfi;\n\t\t\tvar pos;\n\t\t\tvar last = -1;\n\t\t\tvar excerpt;\n\t\t\tvar limit = 150;\n\n\t\t\twhile (pos != -1) {\n\t\t\t\t// Search for the query\n\t\t\t\tpos = text.indexOf(query, last + 1);\n\n\t\t\t\tif (pos != -1) {\n\t\t\t\t\t// We found it! Generate a CFI\n\t\t\t\t\trange = section.document.createRange();\n\t\t\t\t\trange.setStart(node, pos);\n\t\t\t\t\trange.setEnd(node, pos + query.length);\n\n\t\t\t\t\tcfi = section.cfiFromRange(range);\n\n\t\t\t\t\t// Generate the excerpt\n\t\t\t\t\tif (node.textContent.length < limit) {\n\t\t\t\t\t\texcerpt = node.textContent;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\texcerpt = node.textContent.substring(pos - limit/2, pos + limit/2);\n\t\t\t\t\t\texcerpt = \"...\" + excerpt + \"...\";\n\t\t\t\t\t}\n\n\t\t\t\t\t// Add the CFI to the matches list\n\t\t\t\t\tmatches.push({\n\t\t\t\t\t\tcfi: cfi,\n\t\t\t\t\t\texcerpt: excerpt\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tlast = pos;\n\t\t\t}\n\t\t};\n\n\t\tsprint(section.document, function(node) {\n\t\t\tfind(node);\n\t\t});\n\n\t\treturn matches;\n\t};\n\n\n\t/**\n\t * Search a string in multiple sequential Element of the section. If the document.createTreeWalker api is missed(eg: IE8), use `find` as a fallback.\n\t * @param  {string} _query The query string to search\n\t * @param  {int} maxSeqEle The maximum number of Element that are combined for search, default value is 5.\n\t * @return {object[]} A list of matches, with form {cfi, excerpt}\n\t */\n\tsearch(_query , maxSeqEle = 5){\n\t\tif (typeof(document.createTreeWalker) == \"undefined\") {\n\t\t\treturn this.find(_query);\n\t\t}\n\t\tlet matches = [];\n\t\tconst excerptLimit = 150;\n\t\tconst section = this;\n\t\tconst query = _query.toLowerCase();\n\t\tconst search = function(nodeList){\n\t\t\tconst textWithCase =  nodeList.reduce((acc ,current)=>{\n\t\t\t\treturn acc + current.textContent;\n\t\t\t},\"\");\n\t\t\tconst text = textWithCase.toLowerCase();\n\t\t\tconst pos = text.indexOf(query);\n\t\t\tif (pos != -1){\n\t\t\t\tconst startNodeIndex = 0 , endPos = pos + query.length;\n\t\t\t\tlet endNodeIndex = 0 , l = 0;\n\t\t\t\tif (pos < nodeList[startNodeIndex].length){\n\t\t\t\t\tlet cfi;\n\t\t\t\t\twhile( endNodeIndex < nodeList.length - 1 ){\n\t\t\t\t\t\tl += nodeList[endNodeIndex].length;\n\t\t\t\t\t\tif ( endPos <= l){\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tendNodeIndex += 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet startNode = nodeList[startNodeIndex] , endNode = nodeList[endNodeIndex];\n\t\t\t\t\tlet range = section.document.createRange();\n\t\t\t\t\trange.setStart(startNode,pos);\n\t\t\t\t\tlet beforeEndLengthCount =  nodeList.slice(0, endNodeIndex).reduce((acc,current)=>{return acc+current.textContent.length;},0) ;\n\t\t\t\t\trange.setEnd(endNode, beforeEndLengthCount > endPos ? endPos : endPos - beforeEndLengthCount );\n\t\t\t\t\tcfi = section.cfiFromRange(range);\n\n\t\t\t\t\tlet excerpt = nodeList.slice(0, endNodeIndex+1).reduce((acc,current)=>{return acc+current.textContent ;},\"\");\n\t\t\t\t\tif (excerpt.length > excerptLimit){\n\t\t\t\t\t\texcerpt = excerpt.substring(pos - excerptLimit/2, pos + excerptLimit/2);\n\t\t\t\t\t\texcerpt = \"...\" + excerpt + \"...\";\n\t\t\t\t\t}\n\t\t\t\t\tmatches.push({\n\t\t\t\t\t\tcfi: cfi,\n\t\t\t\t\t\texcerpt: excerpt\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst treeWalker = document.createTreeWalker(section.document, NodeFilter.SHOW_TEXT, null, false);\n\t\tlet node , nodeList = [];\n\t\twhile (node = treeWalker.nextNode()) {\n\t\t\tnodeList.push(node);\n\t\t\tif (nodeList.length == maxSeqEle){\n\t\t\t\tsearch(nodeList.slice(0 , maxSeqEle));\n\t\t\t\tnodeList = nodeList.slice(1, maxSeqEle);\n\t\t\t}\n\t\t}\n\t\tif (nodeList.length > 0){\n\t\t\tsearch(nodeList);\n\t\t}\n\t\treturn matches;\n\t}\n\n\t/**\n\t* Reconciles the current chapters layout properties with\n\t* the global layout properties.\n\t* @param {object} globalLayout  The global layout settings object, chapter properties string\n\t* @return {object} layoutProperties Object with layout properties\n\t*/\n\treconcileLayoutSettings(globalLayout){\n\t\t//-- Get the global defaults\n\t\tvar settings = {\n\t\t\tlayout : globalLayout.layout,\n\t\t\tspread : globalLayout.spread,\n\t\t\torientation : globalLayout.orientation\n\t\t};\n\n\t\t//-- Get the chapter's display type\n\t\tthis.properties.forEach(function(prop){\n\t\t\tvar rendition = prop.replace(\"rendition:\", \"\");\n\t\t\tvar split = rendition.indexOf(\"-\");\n\t\t\tvar property, value;\n\n\t\t\tif(split != -1){\n\t\t\t\tproperty = rendition.slice(0, split);\n\t\t\t\tvalue = rendition.slice(split+1);\n\n\t\t\t\tsettings[property] = value;\n\t\t\t}\n\t\t});\n\t\treturn settings;\n\t}\n\n\t/**\n\t * Get a CFI from a Range in the Section\n\t * @param  {range} _range\n\t * @return {string} cfi an EpubCFI string\n\t */\n\tcfiFromRange(_range) {\n\t\treturn new EpubCFI(_range, this.cfiBase).toString();\n\t}\n\n\t/**\n\t * Get a CFI from an Element in the Section\n\t * @param  {element} el\n\t * @return {string} cfi an EpubCFI string\n\t */\n\tcfiFromElement(el) {\n\t\treturn new EpubCFI(el, this.cfiBase).toString();\n\t}\n\n\t/**\n\t * Unload the section document\n\t */\n\tunload() {\n\t\tthis.document = undefined;\n\t\tthis.contents = undefined;\n\t\tthis.output = undefined;\n\t}\n\n\tdestroy() {\n\t\tthis.unload();\n\t\tthis.hooks.serialize.clear();\n\t\tthis.hooks.content.clear();\n\n\t\tthis.hooks = undefined;\n\t\tthis.idref = undefined;\n\t\tthis.linear = undefined;\n\t\tthis.properties = undefined;\n\t\tthis.index = undefined;\n\t\tthis.href = undefined;\n\t\tthis.url = undefined;\n\t\tthis.next = undefined;\n\t\tthis.prev = undefined;\n\n\t\tthis.cfiBase = undefined;\n\t}\n}\n\nexport default Section;\n"],"names":["Section","item","hooks","Hook","_request","request","Request","loading","defer","loaded","xml","error","replaceBase","rendering","rendered","contents","userAgent","isIE","Serializer","XMLDOMSerializer","serializer","_query","section","matches","query","find","node","text","range","cfi","pos","last","excerpt","limit","sprint","maxSeqEle","excerptLimit","search","nodeList","acc","current","endPos","endNodeIndex","l","startNode","endNode","beforeEndLengthCount","treeWalker","globalLayout","settings","prop","rendition","split","property","value","_range","EpubCFI","el"],"mappings":"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","x_google_ignoreList":[0]}