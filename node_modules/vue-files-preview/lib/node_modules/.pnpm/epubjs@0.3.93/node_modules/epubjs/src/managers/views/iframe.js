"use strict";const c=require("../../../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js"),l=require("../../utils/core.js"),p=require("../../epubcfi.js"),g=require("../../contents.js"),d=require("../../utils/constants.js"),f=require("../../../../../../marks-pane@1.0.9/node_modules/marks-pane/lib/marks.js");class u{constructor(t,e){this.settings=l.extend({ignoreClass:"",axis:void 0,direction:void 0,width:0,height:0,layout:void 0,globalLayoutProperties:{},method:void 0,forceRight:!1,allowScriptedContent:!1,allowPopups:!1},e||{}),this.id="epubjs-view-"+l.uuid(),this.section=t,this.index=t.index,this.element=this.container(this.settings.axis),this.added=!1,this.displayed=!1,this.rendered=!1,this.fixedWidth=0,this.fixedHeight=0,this.epubcfi=new p,this.layout=this.settings.layout,this.pane=void 0,this.highlights={},this.underlines={},this.marks={}}container(t){var e=document.createElement("div");return e.classList.add("epub-view"),e.style.height="0px",e.style.width="0px",e.style.overflow="hidden",e.style.position="relative",e.style.display="block",t&&t=="horizontal"?e.style.flex="none":e.style.flex="initial",e}create(){return this.iframe?this.iframe:(this.element||(this.element=this.createContainer()),this.iframe=document.createElement("iframe"),this.iframe.id=this.id,this.iframe.scrolling="no",this.iframe.style.overflow="hidden",this.iframe.seamless="seamless",this.iframe.style.border="none",this.iframe.sandbox="allow-same-origin",this.settings.allowScriptedContent&&(this.iframe.sandbox+=" allow-scripts"),this.settings.allowPopups&&(this.iframe.sandbox+=" allow-popups"),this.iframe.setAttribute("enable-annotation","true"),this.resizing=!0,this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.iframe.style.width="0",this.iframe.style.height="0",this._width=0,this._height=0,this.element.setAttribute("ref",this.index),this.added=!0,this.elementBounds=l.bounds(this.element),"srcdoc"in this.iframe?this.supportsSrcdoc=!0:this.supportsSrcdoc=!1,this.settings.method||(this.settings.method=this.supportsSrcdoc?"srcdoc":"write"),this.iframe)}render(t,e){return this.create(),this.size(),this.sectionRender||(this.sectionRender=this.section.render(t)),this.sectionRender.then((function(i){return this.load(i)}).bind(this)).then((function(){let i=this.contents.writingMode(),s;return this.settings.flow==="scrolled"?s=i.indexOf("vertical")===0?"horizontal":"vertical":s=i.indexOf("vertical")===0?"vertical":"horizontal",i.indexOf("vertical")===0&&this.settings.flow==="paginated"&&(this.layout.delta=this.layout.height),this.setAxis(s),this.emit(d.EVENTS.VIEWS.AXIS,s),this.setWritingMode(i),this.emit(d.EVENTS.VIEWS.WRITING_MODE,i),this.layout.format(this.contents,this.section,this.axis),this.addListeners(),new Promise((n,a)=>{this.expand(),this.settings.forceRight&&(this.element.style.marginLeft=this.width()+"px"),n()})}).bind(this),(function(i){return this.emit(d.EVENTS.VIEWS.LOAD_ERROR,i),new Promise((s,n)=>{n(i)})}).bind(this)).then((function(){this.emit(d.EVENTS.VIEWS.RENDERED,this.section)}).bind(this))}reset(){this.iframe&&(this.iframe.style.width="0",this.iframe.style.height="0",this._width=0,this._height=0,this._textWidth=void 0,this._contentWidth=void 0,this._textHeight=void 0,this._contentHeight=void 0),this._needsReframe=!0}size(t,e){var i=t||this.settings.width,s=e||this.settings.height;this.layout.name==="pre-paginated"?this.lock("both",i,s):this.settings.axis==="horizontal"?this.lock("height",i,s):this.lock("width",i,s),this.settings.width=i,this.settings.height=s}lock(t,e,i){var s=l.borders(this.element),n;this.iframe?n=l.borders(this.iframe):n={width:0,height:0},t=="width"&&l.isNumber(e)&&(this.lockedWidth=e-s.width-n.width),t=="height"&&l.isNumber(i)&&(this.lockedHeight=i-s.height-n.height),t==="both"&&l.isNumber(e)&&l.isNumber(i)&&(this.lockedWidth=e-s.width-n.width,this.lockedHeight=i-s.height-n.height),this.displayed&&this.iframe&&this.expand()}expand(t){var e=this.lockedWidth,i=this.lockedHeight,s;!this.iframe||this._expanding||(this._expanding=!0,this.layout.name==="pre-paginated"?(e=this.layout.columnWidth,i=this.layout.height):this.settings.axis==="horizontal"?(e=this.contents.textWidth(),e%this.layout.pageWidth>0&&(e=Math.ceil(e/this.layout.pageWidth)*this.layout.pageWidth),this.settings.forceEvenPages&&(s=e/this.layout.pageWidth,this.layout.divisor>1&&this.layout.name==="reflowable"&&s%2>0&&(e+=this.layout.pageWidth))):this.settings.axis==="vertical"&&(i=this.contents.textHeight(),this.settings.flow==="paginated"&&i%this.layout.height>0&&(i=Math.ceil(i/this.layout.height)*this.layout.height)),(this._needsReframe||e!=this._width||i!=this._height)&&this.reframe(e,i),this._expanding=!1)}reframe(t,e){var i;l.isNumber(t)&&(this.element.style.width=t+"px",this.iframe.style.width=t+"px",this._width=t),l.isNumber(e)&&(this.element.style.height=e+"px",this.iframe.style.height=e+"px",this._height=e);let s=this.prevBounds?t-this.prevBounds.width:t,n=this.prevBounds?e-this.prevBounds.height:e;i={width:t,height:e,widthDelta:s,heightDelta:n},this.pane&&this.pane.render(),requestAnimationFrame(()=>{let a;for(let o in this.marks)this.marks.hasOwnProperty(o)&&(a=this.marks[o],this.placeMark(a.element,a.range))}),this.onResize(this,i),this.emit(d.EVENTS.VIEWS.RESIZED,i),this.prevBounds=i,this.elementBounds=l.bounds(this.element)}load(t){var e=new l.defer,i=e.promise;if(!this.iframe)return e.reject(new Error("No Iframe Available")),i;if(this.iframe.onload=(function(n){this.onLoad(n,e)}).bind(this),this.settings.method==="blobUrl")this.blobUrl=l.createBlobUrl(t,"application/xhtml+xml"),this.iframe.src=this.blobUrl,this.element.appendChild(this.iframe);else if(this.settings.method==="srcdoc")this.iframe.srcdoc=t,this.element.appendChild(this.iframe);else{if(this.element.appendChild(this.iframe),this.document=this.iframe.contentDocument,!this.document)return e.reject(new Error("No Document Available")),i;if(this.iframe.contentDocument.open(),window.MSApp&&MSApp.execUnsafeLocalFunction){var s=this;MSApp.execUnsafeLocalFunction(function(){s.iframe.contentDocument.write(t)})}else this.iframe.contentDocument.write(t);this.iframe.contentDocument.close()}return i}onLoad(t,e){this.window=this.iframe.contentWindow,this.document=this.iframe.contentDocument,this.contents=new g(this.document,this.document.body,this.section.cfiBase,this.section.index),this.rendering=!1;var i=this.document.querySelector("link[rel='canonical']");i?i.setAttribute("href",this.section.canonical):(i=this.document.createElement("link"),i.setAttribute("rel","canonical"),i.setAttribute("href",this.section.canonical),this.document.querySelector("head").appendChild(i)),this.contents.on(d.EVENTS.CONTENTS.EXPAND,()=>{this.displayed&&this.iframe&&(this.expand(),this.contents&&this.layout.format(this.contents))}),this.contents.on(d.EVENTS.CONTENTS.RESIZE,s=>{this.displayed&&this.iframe&&(this.expand(),this.contents&&this.layout.format(this.contents))}),e.resolve(this.contents)}setLayout(t){this.layout=t,this.contents&&(this.layout.format(this.contents),this.expand())}setAxis(t){this.settings.axis=t,t=="horizontal"?this.element.style.flex="none":this.element.style.flex="initial",this.size()}setWritingMode(t){this.writingMode=t}addListeners(){}removeListeners(t){}display(t){var e=new l.defer;return this.displayed?e.resolve(this):this.render(t).then((function(){this.emit(d.EVENTS.VIEWS.DISPLAYED,this),this.onDisplayed(this),this.displayed=!0,e.resolve(this)}).bind(this),function(i){e.reject(i,this)}),e.promise}show(){this.element.style.visibility="visible",this.iframe&&(this.iframe.style.visibility="visible",this.iframe.style.transform="translateZ(0)",this.iframe.offsetWidth,this.iframe.style.transform=null),this.emit(d.EVENTS.VIEWS.SHOWN,this)}hide(){this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.stopExpanding=!0,this.emit(d.EVENTS.VIEWS.HIDDEN,this)}offset(){return{top:this.element.offsetTop,left:this.element.offsetLeft}}width(){return this._width}height(){return this._height}position(){return this.element.getBoundingClientRect()}locationOf(t){this.iframe.getBoundingClientRect();var e=this.contents.locationOf(t,this.settings.ignoreClass);return{left:e.left,top:e.top}}onDisplayed(t){}onResize(t,e){}bounds(t){return(t||!this.elementBounds)&&(this.elementBounds=l.bounds(this.element)),this.elementBounds}highlight(t,e={},i,s="epubjs-hl",n={}){if(!this.contents)return;const a=Object.assign({fill:"yellow","fill-opacity":"0.3","mix-blend-mode":"multiply"},n);let o=this.contents.range(t),h=()=>{this.emit(d.EVENTS.VIEWS.MARK_CLICKED,t,e)};e.epubcfi=t,this.pane||(this.pane=new f.Pane(this.iframe,this.element));let m=new f.Highlight(o,s,e,a),r=this.pane.addMark(m);return this.highlights[t]={mark:r,element:r.element,listeners:[h,i]},r.element.setAttribute("ref",s),r.element.addEventListener("click",h),r.element.addEventListener("touchstart",h),i&&(r.element.addEventListener("click",i),r.element.addEventListener("touchstart",i)),r}underline(t,e={},i,s="epubjs-ul",n={}){if(!this.contents)return;const a=Object.assign({stroke:"black","stroke-opacity":"0.3","mix-blend-mode":"multiply"},n);let o=this.contents.range(t),h=()=>{this.emit(d.EVENTS.VIEWS.MARK_CLICKED,t,e)};e.epubcfi=t,this.pane||(this.pane=new f.Pane(this.iframe,this.element));let m=new f.Underline(o,s,e,a),r=this.pane.addMark(m);return this.underlines[t]={mark:r,element:r.element,listeners:[h,i]},r.element.setAttribute("ref",s),r.element.addEventListener("click",h),r.element.addEventListener("touchstart",h),i&&(r.element.addEventListener("click",i),r.element.addEventListener("touchstart",i)),r}mark(t,e={},i){if(!this.contents)return;if(t in this.marks)return this.marks[t];let s=this.contents.range(t);if(!s)return;let n=s.commonAncestorContainer,a=n.nodeType===1?n:n.parentNode,o=m=>{this.emit(d.EVENTS.VIEWS.MARK_CLICKED,t,e)};s.collapsed&&n.nodeType===1?(s=new Range,s.selectNodeContents(n)):s.collapsed&&(s=new Range,s.selectNodeContents(a));let h=this.document.createElement("a");return h.setAttribute("ref","epubjs-mk"),h.style.position="absolute",h.dataset.epubcfi=t,e&&Object.keys(e).forEach(m=>{h.dataset[m]=e[m]}),i&&(h.addEventListener("click",i),h.addEventListener("touchstart",i)),h.addEventListener("click",o),h.addEventListener("touchstart",o),this.placeMark(h,s),this.element.appendChild(h),this.marks[t]={element:h,range:s,listeners:[o,i]},a}placeMark(t,e){let i,s,n;if(this.layout.name==="pre-paginated"||this.settings.axis!=="horizontal"){let o=e.getBoundingClientRect();i=o.top,s=o.right}else{let o=e.getClientRects(),h;for(var a=0;a!=o.length;a++)h=o[a],(!n||h.left<n)&&(n=h.left,s=Math.ceil(n/this.layout.props.pageWidth)*this.layout.props.pageWidth-this.layout.gap/2,i=h.top)}t.style.top=`${i}px`,t.style.left=`${s}px`}unhighlight(t){let e;t in this.highlights&&(e=this.highlights[t],this.pane.removeMark(e.mark),e.listeners.forEach(i=>{i&&(e.element.removeEventListener("click",i),e.element.removeEventListener("touchstart",i))}),delete this.highlights[t])}ununderline(t){let e;t in this.underlines&&(e=this.underlines[t],this.pane.removeMark(e.mark),e.listeners.forEach(i=>{i&&(e.element.removeEventListener("click",i),e.element.removeEventListener("touchstart",i))}),delete this.underlines[t])}unmark(t){let e;t in this.marks&&(e=this.marks[t],this.element.removeChild(e.element),e.listeners.forEach(i=>{i&&(e.element.removeEventListener("click",i),e.element.removeEventListener("touchstart",i))}),delete this.marks[t])}destroy(){for(let t in this.highlights)this.unhighlight(t);for(let t in this.underlines)this.ununderline(t);for(let t in this.marks)this.unmark(t);this.blobUrl&&l.revokeBlobUrl(this.blobUrl),this.displayed&&(this.displayed=!1,this.removeListeners(),this.contents.destroy(),this.stopExpanding=!0,this.element.removeChild(this.iframe),this.pane&&(this.pane.element.remove(),this.pane=void 0),this.iframe=void 0,this.contents=void 0,this._textWidth=null,this._textHeight=null,this._width=null,this._height=null)}}c(u.prototype);module.exports=u;
//# sourceMappingURL=iframe.js.map
