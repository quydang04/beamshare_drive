{"version":3,"file":"snap.js","sources":["../../../../../../../../../../node_modules/.pnpm/epubjs@0.3.93/node_modules/epubjs/src/managers/helpers/snap.js"],"sourcesContent":["import {extend, defer, requestAnimationFrame, prefixed} from \"../../utils/core\";\nimport { EVENTS, DOM_EVENTS } from \"../../utils/constants\";\nimport EventEmitter from \"event-emitter\";\n\n// easing equations from https://github.com/danro/easing-js/blob/master/easing.js\nconst PI_D2 = (Math.PI / 2);\nconst EASING_EQUATIONS = {\n\t\teaseOutSine: function (pos) {\n\t\t\t\treturn Math.sin(pos * PI_D2);\n\t\t},\n\t\teaseInOutSine: function (pos) {\n\t\t\t\treturn (-0.5 * (Math.cos(Math.PI * pos) - 1));\n\t\t},\n\t\teaseInOutQuint: function (pos) {\n\t\t\t\tif ((pos /= 0.5) < 1) {\n\t\t\t\t\t\treturn 0.5 * Math.pow(pos, 5);\n\t\t\t\t}\n\t\t\t\treturn 0.5 * (Math.pow((pos - 2), 5) + 2);\n\t\t},\n\t\teaseInCubic: function(pos) {\n\t\t\treturn Math.pow(pos, 3);\n  \t}\n};\n\nclass Snap {\n\tconstructor(manager, options) {\n\n\t\tthis.settings = extend({\n\t\t\tduration: 80,\n\t\t\tminVelocity: 0.2,\n\t\t\tminDistance: 10,\n\t\t\teasing: EASING_EQUATIONS['easeInCubic']\n\t\t}, options || {});\n\n\t\tthis.supportsTouch = this.supportsTouch();\n\n\t\tif (this.supportsTouch) {\n\t\t\tthis.setup(manager);\n\t\t}\n\t}\n\n\tsetup(manager) {\n\t\tthis.manager = manager;\n\n\t\tthis.layout = this.manager.layout;\n\n\t\tthis.fullsize = this.manager.settings.fullsize;\n\t\tif (this.fullsize) {\n\t\t\tthis.element = this.manager.stage.element;\n\t\t\tthis.scroller = window;\n\t\t\tthis.disableScroll();\n\t\t} else {\n\t\t\tthis.element = this.manager.stage.container;\n\t\t\tthis.scroller = this.element;\n\t\t\tthis.element.style[\"WebkitOverflowScrolling\"] = \"touch\";\n\t\t}\n\n\t\t// this.overflow = this.manager.overflow;\n\n\t\t// set lookahead offset to page width\n\t\tthis.manager.settings.offset = this.layout.width;\n\t\tthis.manager.settings.afterScrolledTimeout = this.settings.duration * 2;\n\n\t\tthis.isVertical = this.manager.settings.axis === \"vertical\";\n\n\t\t// disable snapping if not paginated or axis in not horizontal\n\t\tif (!this.manager.isPaginated || this.isVertical) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.touchCanceler = false;\n\t\tthis.resizeCanceler = false;\n\t\tthis.snapping = false;\n\n\n\t\tthis.scrollLeft;\n\t\tthis.scrollTop;\n\n\t\tthis.startTouchX = undefined;\n\t\tthis.startTouchY = undefined;\n\t\tthis.startTime = undefined;\n\t\tthis.endTouchX = undefined;\n\t\tthis.endTouchY = undefined;\n\t\tthis.endTime = undefined;\n\n\t\tthis.addListeners();\n\t}\n\n\tsupportsTouch() {\n\t\tif (('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tdisableScroll() {\n\t\tthis.element.style.overflow = \"hidden\";\n\t}\n\n\tenableScroll() {\n\t\tthis.element.style.overflow = \"\";\n\t}\n\n\taddListeners() {\n\t\tthis._onResize = this.onResize.bind(this);\n\t\twindow.addEventListener('resize', this._onResize);\n\n\t\tthis._onScroll = this.onScroll.bind(this);\n\t\tthis.scroller.addEventListener('scroll', this._onScroll);\n\n\t\tthis._onTouchStart = this.onTouchStart.bind(this);\n\t\tthis.scroller.addEventListener('touchstart', this._onTouchStart, { passive: true });\n\t\tthis.on('touchstart', this._onTouchStart);\n\n\t\tthis._onTouchMove = this.onTouchMove.bind(this);\n\t\tthis.scroller.addEventListener('touchmove', this._onTouchMove, { passive: true });\n\t\tthis.on('touchmove', this._onTouchMove);\n\n\t\tthis._onTouchEnd = this.onTouchEnd.bind(this);\n\t\tthis.scroller.addEventListener('touchend', this._onTouchEnd, { passive: true });\n\t\tthis.on('touchend', this._onTouchEnd);\n\n\t\tthis._afterDisplayed = this.afterDisplayed.bind(this);\n\t\tthis.manager.on(EVENTS.MANAGERS.ADDED, this._afterDisplayed);\n\t}\n\n\tremoveListeners() {\n\t\twindow.removeEventListener('resize', this._onResize);\n\t\tthis._onResize = undefined;\n\n\t\tthis.scroller.removeEventListener('scroll', this._onScroll);\n\t\tthis._onScroll = undefined;\n\n\t\tthis.scroller.removeEventListener('touchstart', this._onTouchStart, { passive: true });\n\t\tthis.off('touchstart', this._onTouchStart);\n\t\tthis._onTouchStart = undefined;\n\n\t\tthis.scroller.removeEventListener('touchmove', this._onTouchMove, { passive: true });\n\t\tthis.off('touchmove', this._onTouchMove);\n\t\tthis._onTouchMove = undefined;\n\n\t\tthis.scroller.removeEventListener('touchend', this._onTouchEnd, { passive: true });\n\t\tthis.off('touchend', this._onTouchEnd);\n\t\tthis._onTouchEnd = undefined;\n\n\t\tthis.manager.off(EVENTS.MANAGERS.ADDED, this._afterDisplayed);\n\t\tthis._afterDisplayed = undefined;\n\t}\n\n\tafterDisplayed(view) {\n\t\tlet contents = view.contents;\n\t\t[\"touchstart\", \"touchmove\", \"touchend\"].forEach((e) => {\n\t\t\tcontents.on(e, (ev) => this.triggerViewEvent(ev, contents));\n\t\t});\n\t}\n\n\ttriggerViewEvent(e, contents){\n\t\tthis.emit(e.type, e, contents);\n\t}\n\n\tonScroll(e) {\n\t\tthis.scrollLeft = this.fullsize ? window.scrollX : this.scroller.scrollLeft;\n\t\tthis.scrollTop = this.fullsize ? window.scrollY : this.scroller.scrollTop;\n\t}\n\n\tonResize(e) {\n\t\tthis.resizeCanceler = true;\n\t}\n\n\tonTouchStart(e) {\n\t\tlet { screenX, screenY } = e.touches[0];\n\n\t\tif (this.fullsize) {\n\t\t\tthis.enableScroll();\n\t\t}\n\n\t\tthis.touchCanceler = true;\n\n\t\tif (!this.startTouchX) {\n\t\t\tthis.startTouchX = screenX;\n\t\t\tthis.startTouchY = screenY;\n\t\t\tthis.startTime = this.now();\n\t\t}\n\n\t\tthis.endTouchX = screenX;\n\t\tthis.endTouchY = screenY;\n\t\tthis.endTime = this.now();\n\t}\n\n\tonTouchMove(e) {\n\t\tlet { screenX, screenY } = e.touches[0];\n\t\tlet deltaY = Math.abs(screenY - this.endTouchY);\n\n\t\tthis.touchCanceler = true;\n\n\n\t\tif (!this.fullsize && deltaY < 10) {\n\t\t\tthis.element.scrollLeft -= screenX - this.endTouchX;\n\t\t}\n\n\t\tthis.endTouchX = screenX;\n\t\tthis.endTouchY = screenY;\n\t\tthis.endTime = this.now();\n\t}\n\n\tonTouchEnd(e) {\n\t\tif (this.fullsize) {\n\t\t\tthis.disableScroll();\n\t\t}\n\n\t\tthis.touchCanceler = false;\n\n\t\tlet swipped = this.wasSwiped();\n\n\t\tif (swipped !== 0) {\n\t\t\tthis.snap(swipped);\n\t\t} else {\n\t\t\tthis.snap();\n\t\t}\n\n\t\tthis.startTouchX = undefined;\n\t\tthis.startTouchY = undefined;\n\t\tthis.startTime = undefined;\n\t\tthis.endTouchX = undefined;\n\t\tthis.endTouchY = undefined;\n\t\tthis.endTime = undefined;\n\t}\n\n\twasSwiped() {\n\t\tlet snapWidth = this.layout.pageWidth * this.layout.divisor;\n\t\tlet distance = (this.endTouchX - this.startTouchX);\n\t\tlet absolute = Math.abs(distance);\n\t\tlet time = this.endTime - this.startTime;\n\t\tlet velocity = (distance / time);\n\t\tlet minVelocity = this.settings.minVelocity;\n\n\t\tif (absolute <= this.settings.minDistance || absolute >= snapWidth) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (velocity > minVelocity) {\n\t\t\t// previous\n\t\t\treturn -1;\n\t\t} else if (velocity < -minVelocity) {\n\t\t\t// next\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tneedsSnap() {\n\t\tlet left = this.scrollLeft;\n\t\tlet snapWidth = this.layout.pageWidth * this.layout.divisor;\n\t\treturn (left % snapWidth) !== 0;\n\t}\n\n\tsnap(howMany=0) {\n\t\tlet left = this.scrollLeft;\n\t\tlet snapWidth = this.layout.pageWidth * this.layout.divisor;\n\t\tlet snapTo = Math.round(left / snapWidth) * snapWidth;\n\n\t\tif (howMany) {\n\t\t\tsnapTo += (howMany * snapWidth);\n\t\t}\n\n\t\treturn this.smoothScrollTo(snapTo);\n\t}\n\n\tsmoothScrollTo(destination) {\n\t\tconst deferred = new defer();\n\t\tconst start = this.scrollLeft;\n\t\tconst startTime = this.now();\n\n\t\tconst duration = this.settings.duration;\n\t\tconst easing = this.settings.easing;\n\n\t\tthis.snapping = true;\n\n\t\t// add animation loop\n\t\tfunction tick() {\n\t\t\tconst now = this.now();\n\t\t\tconst time = Math.min(1, ((now - startTime) / duration));\n\t\t\tconst timeFunction = easing(time);\n\n\n\t\t\tif (this.touchCanceler || this.resizeCanceler) {\n\t\t\t\tthis.resizeCanceler = false;\n\t\t\t\tthis.snapping = false;\n\t\t\t\tdeferred.resolve();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (time < 1) {\n\t\t\t\t\twindow.requestAnimationFrame(tick.bind(this));\n\t\t\t\t\tthis.scrollTo(start + ((destination - start) * time), 0);\n\t\t\t} else {\n\t\t\t\t\tthis.scrollTo(destination, 0);\n\t\t\t\t\tthis.snapping = false;\n\t\t\t\t\tdeferred.resolve();\n\t\t\t}\n\t\t}\n\n\t\ttick.call(this);\n\n\t\treturn deferred.promise;\n\t}\n\n\tscrollTo(left=0, top=0) {\n\t\tif (this.fullsize) {\n\t\t\twindow.scroll(left, top);\n\t\t} else {\n\t\t\tthis.scroller.scrollLeft = left;\n\t\t\tthis.scroller.scrollTop = top;\n\t\t}\n\t}\n\n\tnow() {\n\t\treturn ('now' in window.performance) ? performance.now() : new Date().getTime();\n\t}\n\n\tdestroy() {\n\t\tif (!this.scroller) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.fullsize) {\n\t\t\tthis.enableScroll();\n\t\t}\n\n\t\tthis.removeListeners();\n\n\t\tthis.scroller = undefined;\n\t}\n}\n\nEventEmitter(Snap.prototype);\n\nexport default Snap;\n"],"names":["PI_D2","EASING_EQUATIONS","pos","Snap","manager","options","extend","EVENTS","view","contents","e","ev","screenX","screenY","deltaY","swipped","snapWidth","distance","absolute","time","velocity","minVelocity","left","howMany","snapTo","destination","deferred","defer","start","startTime","duration","easing","tick","now","top","EventEmitter"],"mappings":"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","x_google_ignoreList":[0]}