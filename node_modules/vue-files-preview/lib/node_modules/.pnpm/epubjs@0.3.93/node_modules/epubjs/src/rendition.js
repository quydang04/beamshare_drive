"use strict";const u=require("../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js"),h=require("./utils/core.js"),o=require("./utils/hook.js"),g=require("./epubcfi.js"),E=require("./utils/queue.js"),f=require("./layout.js"),m=require("./themes.js");require("./contents.js");const y=require("./annotations.js"),n=require("./utils/constants.js"),N=require("./managers/views/iframe.js"),b=require("./managers/default/index.js"),T=require("./managers/continuous/index.js");class c{constructor(t,e){this.settings=h.extend(this.settings||{},{width:null,height:null,ignoreClass:"",manager:"default",view:"iframe",flow:null,layout:null,spread:null,minSpreadWidth:800,stylesheet:null,resizeOnOrientationChange:!0,script:null,snap:!1,defaultDirection:"ltr",allowScriptedContent:!1,allowPopups:!1}),h.extend(this.settings,e),typeof this.settings.manager=="object"&&(this.manager=this.settings.manager),this.book=t,this.hooks={},this.hooks.display=new o(this),this.hooks.serialize=new o(this),this.hooks.content=new o(this),this.hooks.unloaded=new o(this),this.hooks.layout=new o(this),this.hooks.render=new o(this),this.hooks.show=new o(this),this.hooks.content.register(this.handleLinks.bind(this)),this.hooks.content.register(this.passEvents.bind(this)),this.hooks.content.register(this.adjustImages.bind(this)),this.book.spine.hooks.content.register(this.injectIdentifier.bind(this)),this.settings.stylesheet&&this.book.spine.hooks.content.register(this.injectStylesheet.bind(this)),this.settings.script&&this.book.spine.hooks.content.register(this.injectScript.bind(this)),this.themes=new m(this),this.annotations=new y(this),this.epubcfi=new g,this.q=new E(this),this.location=void 0,this.q.enqueue(this.book.opened),this.starting=new h.defer,this.started=this.starting.promise,this.q.enqueue(this.start)}setManager(t){this.manager=t}requireManager(t){var e;return typeof t=="string"&&t==="default"?e=b:typeof t=="string"&&t==="continuous"?e=T:e=t,e}requireView(t){var e;return typeof t=="string"&&t==="iframe"?e=N:e=t,e}start(){switch(!this.settings.layout&&(this.book.package.metadata.layout==="pre-paginated"||this.book.displayOptions.fixedLayout==="true")&&(this.settings.layout="pre-paginated"),this.book.package.metadata.spread){case"none":this.settings.spread="none";break;case"both":this.settings.spread=!0;break}this.manager||(this.ViewManager=this.requireManager(this.settings.manager),this.View=this.requireView(this.settings.view),this.manager=new this.ViewManager({view:this.View,queue:this.q,request:this.book.load.bind(this.book),settings:this.settings})),this.direction(this.book.package.metadata.direction||this.settings.defaultDirection),this.settings.globalLayoutProperties=this.determineLayoutProperties(this.book.package.metadata),this.flow(this.settings.globalLayoutProperties.flow),this.layout(this.settings.globalLayoutProperties),this.manager.on(n.EVENTS.MANAGERS.ADDED,this.afterDisplayed.bind(this)),this.manager.on(n.EVENTS.MANAGERS.REMOVED,this.afterRemoved.bind(this)),this.manager.on(n.EVENTS.MANAGERS.RESIZED,this.onResized.bind(this)),this.manager.on(n.EVENTS.MANAGERS.ORIENTATION_CHANGE,this.onOrientationChange.bind(this)),this.manager.on(n.EVENTS.MANAGERS.SCROLLED,this.reportLocation.bind(this)),this.emit(n.EVENTS.RENDITION.STARTED),this.starting.resolve()}attachTo(t){return this.q.enqueue((function(){this.manager.render(t,{width:this.settings.width,height:this.settings.height}),this.emit(n.EVENTS.RENDITION.ATTACHED)}).bind(this))}display(t){return this.displaying&&this.displaying.resolve(),this.q.enqueue(this._display,t)}_display(t){if(this.book){this.epubcfi.isCfiString(t);var e=new h.defer,i=e.promise,s;return this.displaying=e,this.book.locations.length()&&h.isFloat(t)&&(t=this.book.locations.cfiFromPercentage(parseFloat(t))),s=this.book.spine.get(t),s?(this.manager.display(s,t).then(()=>{e.resolve(s),this.displaying=void 0,this.emit(n.EVENTS.RENDITION.DISPLAYED,s),this.reportLocation()},a=>{this.emit(n.EVENTS.RENDITION.DISPLAY_ERROR,a)}),i):(e.reject(new Error("No Section Found")),i)}}afterDisplayed(t){t.on(n.EVENTS.VIEWS.MARK_CLICKED,(e,i)=>this.triggerMarkEvent(e,i,t.contents)),this.hooks.render.trigger(t,this).then(()=>{t.contents?this.hooks.content.trigger(t.contents,this).then(()=>{this.emit(n.EVENTS.RENDITION.RENDERED,t.section,t)}):this.emit(n.EVENTS.RENDITION.RENDERED,t.section,t)})}afterRemoved(t){this.hooks.unloaded.trigger(t,this).then(()=>{this.emit(n.EVENTS.RENDITION.REMOVED,t.section,t)})}onResized(t,e){this.emit(n.EVENTS.RENDITION.RESIZED,{width:t.width,height:t.height},e),this.location&&this.location.start&&this.display(e||this.location.start.cfi)}onOrientationChange(t){this.emit(n.EVENTS.RENDITION.ORIENTATION_CHANGE,t)}moveTo(t){this.manager.moveTo(t)}resize(t,e,i){t&&(this.settings.width=t),e&&(this.settings.height=e),this.manager.resize(t,e,i)}clear(){this.manager.clear()}next(){return this.q.enqueue(this.manager.next.bind(this.manager)).then(this.reportLocation.bind(this))}prev(){return this.q.enqueue(this.manager.prev.bind(this.manager)).then(this.reportLocation.bind(this))}determineLayoutProperties(t){var e,i=this.settings.layout||t.layout||"reflowable",s=this.settings.spread||t.spread||"auto",a=this.settings.orientation||t.orientation||"auto",r=this.settings.flow||t.flow||"auto",l=t.viewport||"",d=this.settings.minSpreadWidth||t.minSpreadWidth||800,p=this.settings.direction||t.direction||"ltr";return(this.settings.width===0||this.settings.width>0)&&(this.settings.height===0||this.settings.height>0),e={layout:i,spread:s,orientation:a,flow:r,viewport:l,minSpreadWidth:d,direction:p},e}flow(t){var e=t;(t==="scrolled"||t==="scrolled-doc"||t==="scrolled-continuous")&&(e="scrolled"),(t==="auto"||t==="paginated")&&(e="paginated"),this.settings.flow=t,this._layout&&this._layout.flow(e),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this.manager&&this.manager.updateFlow(e),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}layout(t){return t&&(this._layout=new f(t),this._layout.spread(t.spread,this.settings.minSpreadWidth),this._layout.on(n.EVENTS.LAYOUT.UPDATED,(e,i)=>{this.emit(n.EVENTS.RENDITION.LAYOUT,e,i)})),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this._layout}spread(t,e){this.settings.spread=t,e&&(this.settings.minSpreadWidth=e),this._layout&&this._layout.spread(t,e),this.manager&&this.manager.isRendered()&&this.manager.updateLayout()}direction(t){this.settings.direction=t||"ltr",this.manager&&this.manager.direction(this.settings.direction),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}reportLocation(){return this.q.enqueue((function(){requestAnimationFrame((function(){var i=this.manager.currentLocation();if(i&&i.then&&typeof i.then=="function")i.then((function(s){let a=this.located(s);!a||!a.start||!a.end||(this.location=a,this.emit(n.EVENTS.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,href:this.location.start.href,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(n.EVENTS.RENDITION.RELOCATED,this.location))}).bind(this));else if(i){let s=this.located(i);if(!s||!s.start||!s.end)return;this.location=s,this.emit(n.EVENTS.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,href:this.location.start.href,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(n.EVENTS.RENDITION.RELOCATED,this.location)}}).bind(this))}).bind(this))}currentLocation(){var t=this.manager.currentLocation();if(t&&t.then&&typeof t.then=="function")t.then((function(e){return this.located(e)}).bind(this));else if(t)return this.located(t)}located(t){if(!t.length)return{};let e=t[0],i=t[t.length-1],s={start:{index:e.index,href:e.href,cfi:e.mapping.start,displayed:{page:e.pages[0]||1,total:e.totalPages}},end:{index:i.index,href:i.href,cfi:i.mapping.end,displayed:{page:i.pages[i.pages.length-1]||1,total:i.totalPages}}},a=this.book.locations.locationFromCfi(e.mapping.start),r=this.book.locations.locationFromCfi(i.mapping.end);a!=null&&(s.start.location=a,s.start.percentage=this.book.locations.percentageFromLocation(a)),r!=null&&(s.end.location=r,s.end.percentage=this.book.locations.percentageFromLocation(r));let l=this.book.pageList.pageFromCfi(e.mapping.start),d=this.book.pageList.pageFromCfi(i.mapping.end);return l!=-1&&(s.start.page=l),d!=-1&&(s.end.page=d),i.index===this.book.spine.last().index&&s.end.displayed.page>=s.end.displayed.total&&(s.atEnd=!0),e.index===this.book.spine.first().index&&s.start.displayed.page===1&&(s.atStart=!0),s}destroy(){this.manager&&this.manager.destroy(),this.book=void 0}passEvents(t){n.DOM_EVENTS.forEach(e=>{t.on(e,i=>this.triggerViewEvent(i,t))}),t.on(n.EVENTS.CONTENTS.SELECTED,e=>this.triggerSelectedEvent(e,t))}triggerViewEvent(t,e){this.emit(t.type,t,e)}triggerSelectedEvent(t,e){this.emit(n.EVENTS.RENDITION.SELECTED,t,e)}triggerMarkEvent(t,e,i){this.emit(n.EVENTS.RENDITION.MARK_CLICKED,t,e,i)}getRange(t,e){var i=new g(t),s=this.manager.visible().filter(function(a){if(i.spinePos===a.index)return!0});if(s.length)return s[0].contents.range(i,e)}adjustImages(t){if(this._layout.name==="pre-paginated")return new Promise(function(a){a()});let e=t.window.getComputedStyle(t.content,null),i=(t.content.offsetHeight-(parseFloat(e.paddingTop)+parseFloat(e.paddingBottom)))*.95,s=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight);return t.addStylesheetRules({img:{"max-width":(this._layout.columnWidth?this._layout.columnWidth-s+"px":"100%")+"!important","max-height":i+"px!important","object-fit":"contain","page-break-inside":"avoid","break-inside":"avoid","box-sizing":"border-box"},svg:{"max-width":(this._layout.columnWidth?this._layout.columnWidth-s+"px":"100%")+"!important","max-height":i+"px!important","page-break-inside":"avoid","break-inside":"avoid"}}),new Promise(function(a,r){setTimeout(function(){a()},1)})}getContents(){return this.manager?this.manager.getContents():[]}views(){return(this.manager?this.manager.views:void 0)||[]}handleLinks(t){t&&t.on(n.EVENTS.CONTENTS.LINK_CLICKED,e=>{let i=this.book.path.relative(e);this.display(i)})}injectStylesheet(t,e){let i=t.createElement("link");i.setAttribute("type","text/css"),i.setAttribute("rel","stylesheet"),i.setAttribute("href",this.settings.stylesheet),t.getElementsByTagName("head")[0].appendChild(i)}injectScript(t,e){let i=t.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",this.settings.script),i.textContent=" ",t.getElementsByTagName("head")[0].appendChild(i)}injectIdentifier(t,e){let i=this.book.packaging.metadata.identifier,s=t.createElement("meta");s.setAttribute("name","dc.relation.ispartof"),i&&s.setAttribute("content",i),t.getElementsByTagName("head")[0].appendChild(s)}}u(c.prototype);module.exports=c;
//# sourceMappingURL=rendition.js.map
