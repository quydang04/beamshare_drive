"use strict";const C=require("./utils/core.js"),y=require("./epubcfi.js"),z=require("./utils/hook.js"),E=require("./utils/replacements.js"),O=require("./utils/request.js"),R=require("../../../../@xmldom_xmldom@0.7.13/node_modules/@xmldom/xmldom/lib/index.js");class T{constructor(e,t){this.idref=e.idref,this.linear=e.linear==="yes",this.properties=e.properties,this.index=e.index,this.href=e.href,this.url=e.url,this.canonical=e.canonical,this.next=e.next,this.prev=e.prev,this.cfiBase=e.cfiBase,t?this.hooks=t:(this.hooks={},this.hooks.serialize=new z(this),this.hooks.content=new z(this)),this.document=void 0,this.contents=void 0,this.output=void 0}load(e){var t=e||this.request||O,o=new C.defer,n=o.promise;return this.contents?o.resolve(this.contents):t(this.url).then((function(i){return this.document=i,this.contents=i.documentElement,this.hooks.content.trigger(this.document,this)}).bind(this)).then((function(){o.resolve(this.contents)}).bind(this)).catch(function(i){o.reject(i)}),n}base(){return E.replaceBase(this.document,this)}render(e){var t=new C.defer,o=t.promise;return this.output,this.load(e).then((function(n){var i=typeof navigator<"u"&&navigator.userAgent||"",r=i.indexOf("Trident")>=0,c;typeof XMLSerializer>"u"||r?c=R.DOMParser:c=XMLSerializer;var u=new c;return this.output=u.serializeToString(n),this.output}).bind(this)).then((function(){return this.hooks.serialize.trigger(this.output,this)}).bind(this)).then((function(){t.resolve(this.output)}).bind(this)).catch(function(n){t.reject(n)}),o}find(e){var t=this,o=[],n=e.toLowerCase(),i=function(r){for(var c=r.textContent.toLowerCase(),u=t.document.createRange(),g,s,h=-1,a,v=150;s!=-1;)s=c.indexOf(n,h+1),s!=-1&&(u=t.document.createRange(),u.setStart(r,s),u.setEnd(r,s+n.length),g=t.cfiFromRange(u),r.textContent.length<v?a=r.textContent:(a=r.textContent.substring(s-v/2,s+v/2),a="..."+a+"..."),o.push({cfi:g,excerpt:a})),h=s};return C.sprint(t.document,function(r){i(r)}),o}search(e,t=5){if(typeof document.createTreeWalker>"u")return this.find(e);let o=[];const n=150,i=this,r=e.toLowerCase(),c=function(h){const d=h.reduce((k,f)=>k+f.textContent,"").toLowerCase().indexOf(r);if(d!=-1){const f=d+r.length;let l=0,b=0;if(d<h[0].length){let S;for(;l<h.length-1&&(b+=h[l].length,!(f<=b));)l+=1;let N=h[0],B=h[l],x=i.document.createRange();x.setStart(N,d);let q=h.slice(0,l).reduce((m,w)=>m+w.textContent.length,0);x.setEnd(B,q>f?f:f-q),S=i.cfiFromRange(x);let p=h.slice(0,l+1).reduce((m,w)=>m+w.textContent,"");p.length>n&&(p=p.substring(d-n/2,d+n/2),p="..."+p+"..."),o.push({cfi:S,excerpt:p})}}},u=document.createTreeWalker(i.document,NodeFilter.SHOW_TEXT,null,!1);let g,s=[];for(;g=u.nextNode();)s.push(g),s.length==t&&(c(s.slice(0,t)),s=s.slice(1,t));return s.length>0&&c(s),o}reconcileLayoutSettings(e){var t={layout:e.layout,spread:e.spread,orientation:e.orientation};return this.properties.forEach(function(o){var n=o.replace("rendition:",""),i=n.indexOf("-"),r,c;i!=-1&&(r=n.slice(0,i),c=n.slice(i+1),t[r]=c)}),t}cfiFromRange(e){return new y(e,this.cfiBase).toString()}cfiFromElement(e){return new y(e,this.cfiBase).toString()}unload(){this.document=void 0,this.contents=void 0,this.output=void 0}destroy(){this.unload(),this.hooks.serialize.clear(),this.hooks.content.clear(),this.hooks=void 0,this.idref=void 0,this.linear=void 0,this.properties=void 0,this.index=void 0,this.href=void 0,this.url=void 0,this.next=void 0,this.prev=void 0,this.cfiBase=void 0}}module.exports=T;
//# sourceMappingURL=section.js.map
