"use strict";const q=require("../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js"),n=require("./utils/core.js"),a=require("./utils/url.js"),p=require("./utils/path.js"),w=require("./spine.js"),b=require("./locations.js"),O=require("./container.js"),g=require("./packaging.js"),d=require("./navigation.js"),k=require("./resources.js"),l=require("./pagelist.js"),P=require("./rendition.js"),E=require("./archive.js"),f=require("./utils/request.js"),A=require("./epubcfi.js"),I=require("./store.js"),u=require("./displayoptions.js"),v=require("./utils/constants.js"),m="META-INF/container.xml",T="META-INF/com.apple.ibooks.display-options.xml",r={BINARY:"binary",BASE64:"base64",EPUB:"epub",OPF:"opf",MANIFEST:"json",DIRECTORY:"directory"};class y{constructor(e,i){typeof i>"u"&&typeof e!="string"&&!(e instanceof Blob)&&!(e instanceof ArrayBuffer)&&(i=e,e=void 0),this.settings=n.extend(this.settings||{},{requestMethod:void 0,requestCredentials:void 0,requestHeaders:void 0,encoding:void 0,replacements:void 0,canonical:void 0,openAs:void 0,store:void 0}),n.extend(this.settings,i),this.opening=new n.defer,this.opened=this.opening.promise,this.isOpen=!1,this.loading={manifest:new n.defer,spine:new n.defer,metadata:new n.defer,cover:new n.defer,navigation:new n.defer,pageList:new n.defer,resources:new n.defer,displayOptions:new n.defer},this.loaded={manifest:this.loading.manifest.promise,spine:this.loading.spine.promise,metadata:this.loading.metadata.promise,cover:this.loading.cover.promise,navigation:this.loading.navigation.promise,pageList:this.loading.pageList.promise,resources:this.loading.resources.promise,displayOptions:this.loading.displayOptions.promise},this.ready=Promise.all([this.loaded.manifest,this.loaded.spine,this.loaded.metadata,this.loaded.cover,this.loaded.navigation,this.loaded.resources,this.loaded.displayOptions]),this.isRendered=!1,this.request=this.settings.requestMethod||f,this.spine=new w,this.locations=new b(this.spine,this.load.bind(this)),this.navigation=void 0,this.pageList=void 0,this.url=void 0,this.path=void 0,this.archived=!1,this.archive=void 0,this.storage=void 0,this.resources=void 0,this.rendition=void 0,this.container=void 0,this.packaging=void 0,this.displayOptions=void 0,this.settings.store&&this.store(this.settings.store),e&&this.open(e,this.settings.openAs).catch(s=>{var t=new Error("Cannot load book at "+e);this.emit(v.EVENTS.BOOK.OPEN_FAILED,t)})}open(e,i){var s,t=i||this.determineType(e);return t===r.BINARY?(this.archived=!0,this.url=new a("/",""),s=this.openEpub(e)):t===r.BASE64?(this.archived=!0,this.url=new a("/",""),s=this.openEpub(e,t)):t===r.EPUB?(this.archived=!0,this.url=new a("/",""),s=this.request(e,"binary",this.settings.requestCredentials,this.settings.requestHeaders).then(this.openEpub.bind(this))):t==r.OPF?(this.url=new a(e),s=this.openPackaging(this.url.Path.toString())):t==r.MANIFEST?(this.url=new a(e),s=this.openManifest(this.url.Path.toString())):(this.url=new a(e),s=this.openContainer(m).then(this.openPackaging.bind(this))),s}openEpub(e,i){return this.unarchive(e,i||this.settings.encoding).then(()=>this.openContainer(m)).then(s=>this.openPackaging(s))}openContainer(e){return this.load(e).then(i=>(this.container=new O(i),this.resolve(this.container.packagePath)))}openPackaging(e){return this.path=new p(e),this.load(e).then(i=>(this.packaging=new g(i),this.unpack(this.packaging)))}openManifest(e){return this.path=new p(e),this.load(e).then(i=>(this.packaging=new g,this.packaging.load(i),this.unpack(this.packaging)))}load(e){var i=this.resolve(e);return this.archived?this.archive.request(i):this.request(i,null,this.settings.requestCredentials,this.settings.requestHeaders)}resolve(e,i){if(e){var s=e,t=e.indexOf("://")>-1;return t?e:(this.path&&(s=this.path.resolve(e)),i!=!1&&this.url&&(s=this.url.resolve(s)),s)}}canonical(e){var i=e;return e?(this.settings.canonical?i=this.settings.canonical(e):i=this.resolve(e,!0),i):""}determineType(e){var i,s,t;if(this.settings.encoding==="base64")return r.BASE64;if(typeof e!="string")return r.BINARY;if(i=new a(e),s=i.path(),t=s.extension,t&&(t=t.replace(/\?.*$/,"")),!t)return r.DIRECTORY;if(t==="epub")return r.EPUB;if(t==="opf")return r.OPF;if(t==="json")return r.MANIFEST}unpack(e){this.package=e,this.packaging.metadata.layout===""?this.load(this.url.resolve(T)).then(i=>{this.displayOptions=new u(i),this.loading.displayOptions.resolve(this.displayOptions)}).catch(i=>{this.displayOptions=new u,this.loading.displayOptions.resolve(this.displayOptions)}):(this.displayOptions=new u,this.loading.displayOptions.resolve(this.displayOptions)),this.spine.unpack(this.packaging,this.resolve.bind(this),this.canonical.bind(this)),this.resources=new k(this.packaging.manifest,{archive:this.archive,resolver:this.resolve.bind(this),request:this.request.bind(this),replacements:this.settings.replacements||(this.archived?"blobUrl":"base64")}),this.loadNavigation(this.packaging).then(()=>{this.loading.navigation.resolve(this.navigation)}),this.packaging.coverPath&&(this.cover=this.resolve(this.packaging.coverPath)),this.loading.manifest.resolve(this.packaging.manifest),this.loading.metadata.resolve(this.packaging.metadata),this.loading.spine.resolve(this.spine),this.loading.cover.resolve(this.cover),this.loading.resources.resolve(this.resources),this.loading.pageList.resolve(this.pageList),this.isOpen=!0,this.archived||this.settings.replacements&&this.settings.replacements!="none"?this.replacements().then(()=>{this.loaded.displayOptions.then(()=>{this.opening.resolve(this)})}).catch(i=>{console.error(i)}):this.loaded.displayOptions.then(()=>{this.opening.resolve(this)})}loadNavigation(e){let i=e.navPath||e.ncxPath,s=e.toc;return s?new Promise((t,o)=>{this.navigation=new d(s),e.pageList&&(this.pageList=new l(e.pageList)),t(this.navigation)}):i?this.load(i,"xml").then(t=>(this.navigation=new d(t),this.pageList=new l(t),this.navigation)):new Promise((t,o)=>{this.navigation=new d,this.pageList=new l,t(this.navigation)})}section(e){return this.spine.get(e)}renderTo(e,i){return this.rendition=new P(this,i),this.rendition.attachTo(e),this.rendition}setRequestCredentials(e){this.settings.requestCredentials=e}setRequestHeaders(e){this.settings.requestHeaders=e}unarchive(e,i){return this.archive=new E,this.archive.open(e,i)}store(e){let i=this.settings.replacements&&this.settings.replacements!=="none",s=this.url,t=this.settings.requestMethod||f.bind(this);return this.storage=new I(e,t,this.resolve.bind(this)),this.request=this.storage.request.bind(this.storage),this.opened.then(()=>{this.archived&&(this.storage.requester=this.archive.request.bind(this.archive));let o=(h,c)=>{c.output=this.resources.substitute(h,c.url)};this.resources.settings.replacements=i||"blobUrl",this.resources.replacements().then(()=>this.resources.replaceCss()),this.storage.on("offline",()=>{this.url=new a("/",""),this.spine.hooks.serialize.register(o)}),this.storage.on("online",()=>{this.url=s,this.spine.hooks.serialize.deregister(o)})}),this.storage}coverUrl(){return this.loaded.cover.then(()=>this.cover?this.archived?this.archive.createUrl(this.cover):this.cover:null)}replacements(){return this.spine.hooks.serialize.register((e,i)=>{i.output=this.resources.substitute(e,i.url)}),this.resources.replacements().then(()=>this.resources.replaceCss())}getRange(e){var i=new A(e),s=this.spine.get(i.spinePos),t=this.load.bind(this);return s?s.load(t).then(function(o){var h=i.toRange(s.document);return h}):new Promise((o,h)=>{h("CFI could not be found")})}key(e){var i=e||this.packaging.metadata.identifier||this.url.filename;return`epubjs:${v.EPUBJS_VERSION}:${i}`}destroy(){this.opened=void 0,this.loading=void 0,this.loaded=void 0,this.ready=void 0,this.isOpen=!1,this.isRendered=!1,this.spine&&this.spine.destroy(),this.locations&&this.locations.destroy(),this.pageList&&this.pageList.destroy(),this.archive&&this.archive.destroy(),this.resources&&this.resources.destroy(),this.container&&this.container.destroy(),this.packaging&&this.packaging.destroy(),this.rendition&&this.rendition.destroy(),this.displayOptions&&this.displayOptions.destroy(),this.spine=void 0,this.locations=void 0,this.pageList=void 0,this.archive=void 0,this.resources=void 0,this.container=void 0,this.packaging=void 0,this.rendition=void 0,this.navigation=void 0,this.url=void 0,this.path=void 0,this.archived=!1}}q(y.prototype);module.exports=y;
//# sourceMappingURL=book.js.map
