"use strict";const n=require("./utils/core.js");class u{constructor(e){this.manifest={},this.navPath="",this.ncxPath="",this.coverPath="",this.spineNodeIndex=0,this.spine=[],this.metadata={},e&&this.parse(e)}parse(e){var i,t,r;if(!e)throw new Error("Package File Not Found");if(i=n.qs(e,"metadata"),!i)throw new Error("No Metadata Found");if(t=n.qs(e,"manifest"),!t)throw new Error("No Manifest Found");if(r=n.qs(e,"spine"),!r)throw new Error("No Spine Found");return this.manifest=this.parseManifest(t),this.navPath=this.findNavPath(t),this.ncxPath=this.findNcxPath(t,r),this.coverPath=this.findCoverPath(e),this.spineNodeIndex=n.indexOfElementNode(r),this.spine=this.parseSpine(r,this.manifest),this.uniqueIdentifier=this.findUniqueIdentifier(e),this.metadata=this.parseMetadata(i),this.metadata.direction=r.getAttribute("page-progression-direction"),{metadata:this.metadata,spine:this.spine,manifest:this.manifest,navPath:this.navPath,ncxPath:this.ncxPath,coverPath:this.coverPath,spineNodeIndex:this.spineNodeIndex}}parseMetadata(e){var i={};return i.title=this.getElementText(e,"title"),i.creator=this.getElementText(e,"creator"),i.description=this.getElementText(e,"description"),i.pubdate=this.getElementText(e,"date"),i.publisher=this.getElementText(e,"publisher"),i.identifier=this.getElementText(e,"identifier"),i.language=this.getElementText(e,"language"),i.rights=this.getElementText(e,"rights"),i.modified_date=this.getPropertyText(e,"dcterms:modified"),i.layout=this.getPropertyText(e,"rendition:layout"),i.orientation=this.getPropertyText(e,"rendition:orientation"),i.flow=this.getPropertyText(e,"rendition:flow"),i.viewport=this.getPropertyText(e,"rendition:viewport"),i.media_active_class=this.getPropertyText(e,"media:active-class"),i.spread=this.getPropertyText(e,"rendition:spread"),i}parseManifest(e){var i={},t=n.qsa(e,"item"),r=Array.prototype.slice.call(t);return r.forEach(function(a){var s=a.getAttribute("id"),o=a.getAttribute("href")||"",p=a.getAttribute("media-type")||"",d=a.getAttribute("media-overlay")||"",h=a.getAttribute("properties")||"";i[s]={href:o,type:p,overlay:d,properties:h.length?h.split(" "):[]}}),i}parseSpine(e,i){var t=[],r=n.qsa(e,"itemref"),a=Array.prototype.slice.call(r);return a.forEach(function(s,o){var p=s.getAttribute("idref"),d=s.getAttribute("properties")||"",h=d.length?d.split(" "):[],f={id:s.getAttribute("id"),idref:p,linear:s.getAttribute("linear")||"yes",properties:h,index:o};t.push(f)}),t}findUniqueIdentifier(e){var i=e.documentElement.getAttribute("unique-identifier");if(!i)return"";var t=e.getElementById(i);return t&&t.localName==="identifier"&&t.namespaceURI==="http://purl.org/dc/elements/1.1/"&&t.childNodes.length>0?t.childNodes[0].nodeValue.trim():""}findNavPath(e){var i=n.qsp(e,"item",{properties:"nav"});return i?i.getAttribute("href"):!1}findNcxPath(e,i){var t=n.qsp(e,"item",{"media-type":"application/x-dtbncx+xml"}),r;return t||(r=i.getAttribute("toc"),r&&(t=e.querySelector(`#${r}`))),t?t.getAttribute("href"):!1}findCoverPath(e){var i=n.qs(e,"package");i.getAttribute("version");var t=n.qsp(e,"item",{properties:"cover-image"});if(t)return t.getAttribute("href");var r=n.qsp(e,"meta",{name:"cover"});if(r){var a=r.getAttribute("content"),s=e.getElementById(a);return s?s.getAttribute("href"):""}else return!1}getElementText(e,i){var t=e.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",i),r;return!t||t.length===0?"":(r=t[0],r.childNodes.length?r.childNodes[0].nodeValue:"")}getPropertyText(e,i){var t=n.qsp(e,"meta",{property:i});return t&&t.childNodes.length?t.childNodes[0].nodeValue:""}load(e){this.metadata=e.metadata;let i=e.readingOrder||e.spine;return this.spine=i.map((t,r)=>(t.index=r,t.linear=t.linear||"yes",t)),e.resources.forEach((t,r)=>{this.manifest[r]=t,t.rel&&t.rel[0]==="cover"&&(this.coverPath=t.href)}),this.spineNodeIndex=0,this.toc=e.toc.map((t,r)=>(t.label=t.title,t)),{metadata:this.metadata,spine:this.spine,manifest:this.manifest,navPath:this.navPath,ncxPath:this.ncxPath,coverPath:this.coverPath,spineNodeIndex:this.spineNodeIndex,toc:this.toc}}destroy(){this.manifest=void 0,this.navPath=void 0,this.ncxPath=void 0,this.coverPath=void 0,this.spineNodeIndex=void 0,this.spine=void 0,this.metadata=void 0}}module.exports=u;
//# sourceMappingURL=packaging.js.map
