"use strict";const a=require("./utils/core.js"),w=require("./utils/request.js"),h=require("./utils/mime.js"),f=require("./utils/path.js"),v=require("../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js"),l=require("../../../../localforage@1.10.0/node_modules/localforage/dist/localforage.js");class u{constructor(e,t,r){this.urlCache={},this.storage=void 0,this.name=e,this.requester=t||w,this.resolver=r,this.online=!0,this.checkRequirements(),this.addListeners()}checkRequirements(){try{let e;typeof l>"u"&&(e=l),this.storage=e.createInstance({name:this.name})}catch{throw new Error("localForage lib not loaded")}}addListeners(){this._status=this.status.bind(this),window.addEventListener("online",this._status),window.addEventListener("offline",this._status)}removeListeners(){window.removeEventListener("online",this._status),window.removeEventListener("offline",this._status),this._status=void 0}status(e){let t=navigator.onLine;this.online=t,t?this.emit("online",this):this.emit("offline",this)}add(e,t){let r=e.resources.map(s=>{let{href:i}=s,n=this.resolver(i),o=window.encodeURIComponent(n);return this.storage.getItem(o).then(d=>!d||t?this.requester(n,"binary").then(c=>this.storage.setItem(o,c)):d)});return Promise.all(r)}put(e,t,r){let s=window.encodeURIComponent(e);return this.storage.getItem(s).then(i=>i||this.requester(e,"binary",t,r).then(n=>this.storage.setItem(s,n)))}request(e,t,r,s){return this.online?this.requester(e,t,r,s).then(i=>(this.put(e),i)):this.retrieve(e,t)}retrieve(e,t){new a.defer;var r,s=new f(e);return t||(t=s.extension),t=="blob"?r=this.getBlob(e):r=this.getText(e),r.then(i=>{var n=new a.defer,o;return i?(o=this.handleResponse(i,t),n.resolve(o)):n.reject({message:"File not found in storage: "+e,stack:new Error().stack}),n.promise})}handleResponse(e,t){var r;return t=="json"?r=JSON.parse(e):a.isXml(t)?r=a.parse(e,"text/xml"):t=="xhtml"?r=a.parse(e,"application/xhtml+xml"):t=="html"||t=="htm"?r=a.parse(e,"text/html"):r=e,r}getBlob(e,t){let r=window.encodeURIComponent(e);return this.storage.getItem(r).then(function(s){if(s)return t=t||h.lookup(e),new Blob([s],{type:t})})}getText(e,t){let r=window.encodeURIComponent(e);return t=t||h.lookup(e),this.storage.getItem(r).then(function(s){var i=new a.defer,n=new FileReader,o;if(s)return o=new Blob([s],{type:t}),n.addEventListener("loadend",()=>{i.resolve(n.result)}),n.readAsText(o,t),i.promise})}getBase64(e,t){let r=window.encodeURIComponent(e);return t=t||h.lookup(e),this.storage.getItem(r).then(s=>{var i=new a.defer,n=new FileReader,o;if(s)return o=new Blob([s],{type:t}),n.addEventListener("loadend",()=>{i.resolve(n.result)}),n.readAsDataURL(o,t),i.promise})}createUrl(e,t){var r=new a.defer,s=window.URL||window.webkitURL||window.mozURL,i,n,o=t&&t.base64;return e in this.urlCache?(r.resolve(this.urlCache[e]),r.promise):(o?(n=this.getBase64(e),n&&n.then((function(d){this.urlCache[e]=d,r.resolve(d)}).bind(this))):(n=this.getBlob(e),n&&n.then((function(d){i=s.createObjectURL(d),this.urlCache[e]=i,r.resolve(i)}).bind(this))),n||r.reject({message:"File not found in storage: "+e,stack:new Error().stack}),r.promise)}revokeUrl(e){var t=window.URL||window.webkitURL||window.mozURL,r=this.urlCache[e];r&&t.revokeObjectURL(r)}destroy(){var e=window.URL||window.webkitURL||window.mozURL;for(let t in this.urlCache)e.revokeObjectURL(t);this.urlCache={},this.removeListeners()}}v(u.prototype);module.exports=u;
//# sourceMappingURL=store.js.map
