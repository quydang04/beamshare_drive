"use strict";const _=require("./utils/core.js"),C=require("./utils/queue.js"),f=require("./epubcfi.js"),q=require("./utils/constants.js"),w=require("../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js");class m{constructor(t,e,r){this.spine=t,this.request=e,this.pause=r||100,this.q=new C(this),this.epubcfi=new f,this._locations=[],this._locationsWords=[],this.total=0,this.break=150,this._current=0,this._wordCounter=0,this.currentLocation="",this._currentCfi="",this.processingTimeout=void 0}generate(t){return t&&(this.break=t),this.q.pause(),this.spine.each((function(e){e.linear&&this.q.enqueue(this.process.bind(this),e)}).bind(this)),this.q.run().then((function(){return this.total=this._locations.length-1,this._currentCfi&&(this.currentLocation=this._currentCfi),this._locations}).bind(this))}createRange(){return{startContainer:void 0,startOffset:void 0,endContainer:void 0,endOffset:void 0}}process(t){return t.load(this.request).then((function(e){var r=new _.defer,i=this.parse(e,t.cfiBase);return this._locations=this._locations.concat(i),t.unload(),this.processingTimeout=setTimeout(()=>r.resolve(i),this.pause),r.promise}).bind(this))}parse(t,e,r){var i=[],n,d=t.ownerDocument,c=_.qs(d,"body"),h=0,p,g=r||this.break,v=function(u){var a=u.length,o,s=0;if(u.textContent.trim().length===0)return!1;for(h==0&&(n=this.createRange(),n.startContainer=u,n.startOffset=0),o=g-h,o>a&&(h+=a,s=a);s<a;)if(o=g-h,h===0&&(s+=1,n=this.createRange(),n.startContainer=u,n.startOffset=s),s+o>=a)h+=a-s,s=a;else{s+=o,n.endContainer=u,n.endOffset=s;let l=new f(n,e).toString();i.push(l),h=0}p=u};if(_.sprint(c,v.bind(this)),n&&n.startContainer&&p){n.endContainer=p,n.endOffset=p.length;let u=new f(n,e).toString();i.push(u),h=0}return i}generateFromWords(t,e,r){var i=t?new f(t):void 0;return this.q.pause(),this._locationsWords=[],this._wordCounter=0,this.spine.each((function(n){n.linear&&(i?n.index>=i.spinePos&&this.q.enqueue(this.processWords.bind(this),n,e,i,r):this.q.enqueue(this.processWords.bind(this),n,e,i,r))}).bind(this)),this.q.run().then((function(){return this._currentCfi&&(this.currentLocation=this._currentCfi),this._locationsWords}).bind(this))}processWords(t,e,r,i){return i&&this._locationsWords.length>=i?Promise.resolve():t.load(this.request).then((function(n){var d=new _.defer,c=this.parseWords(n,t,e,r),h=i-this._locationsWords.length;return this._locationsWords=this._locationsWords.concat(c.length>=i?c.slice(0,h):c),t.unload(),this.processingTimeout=setTimeout(()=>d.resolve(c),this.pause),d.promise}).bind(this))}countWords(t){return t=t.replace(/(^\s*)|(\s*$)/gi,""),t=t.replace(/[ ]{2,}/gi," "),t=t.replace(/\n /,`
`),t.split(" ").length}parseWords(t,e,r,i){var n=e.cfiBase,d=[],c=t.ownerDocument,h=_.qs(c,"body"),p=r,g=i?i.spinePos!==e.index:!0,v;i&&e.index===i.spinePos&&(v=i.findNode(i.range?i.path.steps.concat(i.start.steps):i.path.steps,t.ownerDocument));var u=function(a){if(!g)if(a===v)g=!0;else return!1;if(a.textContent.length<10&&a.textContent.trim().length===0)return!1;var o=this.countWords(a.textContent),s,l=0;if(o===0)return!1;for(s=p-this._wordCounter,s>o&&(this._wordCounter+=o,l=o);l<o;)if(s=p-this._wordCounter,l+s>=o)this._wordCounter+=o-l,l=o;else{l+=s;let b=new f(a,n);d.push({cfi:b.toString(),wordCount:this._wordCounter}),this._wordCounter=0}};return _.sprint(h,u.bind(this)),d}locationFromCfi(t){let e;return f.prototype.isCfiString(t)&&(t=new f(t)),this._locations.length===0?-1:(e=_.locationOf(t,this._locations,this.epubcfi.compare),e>this.total?this.total:e)}percentageFromCfi(t){if(this._locations.length===0)return null;var e=this.locationFromCfi(t);return this.percentageFromLocation(e)}percentageFromLocation(t){return!t||!this.total?0:t/this.total}cfiFromLocation(t){var e=-1;return typeof t!="number"&&(t=parseInt(t)),t>=0&&t<this._locations.length&&(e=this._locations[t]),e}cfiFromPercentage(t){let e;if(t>1&&console.warn("Normalize cfiFromPercentage value to between 0 - 1"),t>=1){let r=new f(this._locations[this.total]);return r.collapse(),r.toString()}return e=Math.ceil(this.total*t),this.cfiFromLocation(e)}load(t){return typeof t=="string"?this._locations=JSON.parse(t):this._locations=t,this.total=this._locations.length-1,this._locations}save(){return JSON.stringify(this._locations)}getCurrent(){return this._current}setCurrent(t){var e;if(typeof t=="string")this._currentCfi=t;else if(typeof t=="number")this._current=t;else return;this._locations.length!==0&&(typeof t=="string"?(e=this.locationFromCfi(t),this._current=e):e=t,this.emit(q.EVENTS.LOCATIONS.CHANGED,{percentage:this.percentageFromLocation(e)}))}get currentLocation(){return this._current}set currentLocation(t){this.setCurrent(t)}length(){return this._locations.length}destroy(){this.spine=void 0,this.request=void 0,this.pause=void 0,this.q.stop(),this.q=void 0,this.epubcfi=void 0,this._locations=void 0,this.total=void 0,this.break=void 0,this._current=void 0,this.currentLocation=void 0,this._currentCfi=void 0,clearTimeout(this.processingTimeout)}}w(m.prototype);module.exports=m;
//# sourceMappingURL=locations.js.map
