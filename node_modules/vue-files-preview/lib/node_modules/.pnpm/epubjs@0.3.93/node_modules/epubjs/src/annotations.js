"use strict";const x=require("../../../../event-emitter@0.3.5/node_modules/event-emitter/index.js"),_=require("./epubcfi.js"),l=require("./utils/constants.js");class I{constructor(t){this.rendition=t,this.highlights=[],this.underlines=[],this.marks=[],this._annotations={},this._annotationsBySectionIndex={},this.rendition.hooks.render.register(this.inject.bind(this)),this.rendition.hooks.unloaded.register(this.clear.bind(this))}add(t,n,i,e,s,a){let h=encodeURI(n+t),o=new _(n).spinePos,r=new u({type:t,cfiRange:n,data:i,sectionIndex:o,cb:e,className:s,styles:a});return this._annotations[h]=r,o in this._annotationsBySectionIndex?this._annotationsBySectionIndex[o].push(h):this._annotationsBySectionIndex[o]=[h],this.rendition.views().forEach(c=>{r.sectionIndex===c.index&&r.attach(c)}),r}remove(t,n){let i=encodeURI(t+n);if(i in this._annotations){let e=this._annotations[i];if(n&&e.type!==n)return;this.rendition.views().forEach(a=>{this._removeFromAnnotationBySectionIndex(e.sectionIndex,i),e.sectionIndex===a.index&&e.detach(a)}),delete this._annotations[i]}}_removeFromAnnotationBySectionIndex(t,n){this._annotationsBySectionIndex[t]=this._annotationsAt(t).filter(i=>i!==n)}_annotationsAt(t){return this._annotationsBySectionIndex[t]}highlight(t,n,i,e,s){return this.add("highlight",t,n,i,e,s)}underline(t,n,i,e,s){return this.add("underline",t,n,i,e,s)}mark(t,n,i){return this.add("mark",t,n,i)}each(){return this._annotations.forEach.apply(this._annotations,arguments)}inject(t){let n=t.index;n in this._annotationsBySectionIndex&&this._annotationsBySectionIndex[n].forEach(e=>{this._annotations[e].attach(t)})}clear(t){let n=t.index;n in this._annotationsBySectionIndex&&this._annotationsBySectionIndex[n].forEach(e=>{this._annotations[e].detach(t)})}show(){}hide(){}}class u{constructor({type:t,cfiRange:n,data:i,sectionIndex:e,cb:s,className:a,styles:h}){this.type=t,this.cfiRange=n,this.data=i,this.sectionIndex=e,this.mark=void 0,this.cb=s,this.className=a,this.styles=h}update(t){this.data=t}attach(t){let{cfiRange:n,data:i,type:e,mark:s,cb:a,className:h,styles:d}=this,o;return e==="highlight"?o=t.highlight(n,i,a,h,d):e==="underline"?o=t.underline(n,i,a,h,d):e==="mark"&&(o=t.mark(n,i,a)),this.mark=o,this.emit(l.EVENTS.ANNOTATION.ATTACH,o),o}detach(t){let{cfiRange:n,type:i}=this,e;return t&&(i==="highlight"?e=t.unhighlight(n):i==="underline"?e=t.ununderline(n):i==="mark"&&(e=t.unmark(n))),this.mark=void 0,this.emit(l.EVENTS.ANNOTATION.DETACH,e),e}text(){}}x(u.prototype);module.exports=I;
//# sourceMappingURL=annotations.js.map
